<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å¤šåŠŸèƒ½å›¾ç‰‡å¤„ç†å·¥å…·é›† - OCRåŒ¹é… & æ ¼å¼è½¬æ¢ä¸€ä½“åŒ–</title>

    <!-- å¤–éƒ¨ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/string-similarity@4.0.4/umd/string-similarity.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            max-width: 100%; margin: 20px; background: rgba(255, 255, 255, 0.95);
            border-radius: 15px; padding: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 40px);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            color: #333; font-size: 2.5em; font-weight: 300; margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .header p { color: #666; font-size: 1.2em; margin-bottom: 20px; }

        .workflow-container { display: flex; flex-direction: column; gap: 30px; }
        .step-section {
            background: #f8f9fa; border-radius: 15px; padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border-left: 5px solid #667eea;
        }
        .step-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .step-number {
            background: linear-gradient(45deg, #667eea, #764ba2); color: white;
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em;
        }
        .step-title { color: #333; font-size: 1.5em; font-weight: 600; }

        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .upload-group {
            background: white; border: 2px dashed #dee2e6; border-radius: 10px;
            padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;
        }
        .upload-group:hover { border-color: #667eea; background: #f8f9ff; }
        .upload-group.drag-over { border-color: #667eea; background: #e3f2fd; transform: scale(1.02); }
        .upload-icon { font-size: 3em; margin-bottom: 10px; color: #667eea; }
        .upload-text { color: #495057; font-weight: 600; margin-bottom: 5px; }
        .upload-hint { color: #6c757d; font-size: 0.9em; }
        .file-count {
            margin-top: 10px; padding: 5px 10px; background: #e3f2fd;
            border-radius: 15px; color: #1976d2; font-weight: 500; display: inline-block;
        }

        .preview-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;
            min-height: 650px;
        }
        .preview-section {
            background: white; border-radius: 10px; padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .preview-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f1f1f1;
        }
        .preview-title { font-weight: 600; color: #495057; display: flex; align-items: center; gap: 8px; }
        .preview-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 15px; max-height: 600px; overflow-y: auto; padding: 10px;
        }

        .image-item {
            background: #f8f9fa; border-radius: 8px; padding: 10px; text-align: center;
            cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; position: relative;
        }
        .image-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .image-item.selected {
            border-color: #667eea !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3) !important;
            transform: scale(1.05) !important;
            z-index: 10;
        }
        .image-item.matched { border-color: #28a745; background: #f8fff9; }
        .image-item.unmatched { border-color: #dc3545; background: #fff5f5; opacity: 0.8; }
        .image-item.unmatched:hover { opacity: 1; }
        .image-item img {
            width: 100%; height: 120px; object-fit: contain;
            border-radius: 6px; margin-bottom: 8px;
        }
        .image-filename {
            font-size: 12px; font-weight: 600; margin-bottom: 5px;
            word-break: break-all; line-height: 1.3;
        }
        .image-ocr-text {
            font-size: 11px; color: #666; background: #e9ecef;
            padding: 4px 6px; border-radius: 4px; margin-bottom: 5px;
            max-height: 40px; overflow: hidden;
        }
        .image-resolution { font-size: 10px; color: #999; font-style: italic; }

        .delete-btn {
            position: absolute; top: 5px; right: 5px; background: rgba(255, 255, 255, 0.9);
            border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
            font-size: 14px; color: #dc3545; display: none; align-items: center; justify-content: center;
        }
        .image-item:hover .delete-btn { display: flex; }

        .controls {
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;
            margin: 20px 0; padding: 20px; background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }
        .btn {
            padding: 12px 24px; font-size: 14px; font-weight: 600; border: none;
            border-radius: 25px; cursor: pointer; transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 0.5px; min-width: 140px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049); color: white;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2); color: white;
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
        }
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 6px 12px rgba(33, 150, 243, 0.4);
        }
        .btn-warning {
            background: linear-gradient(45deg, #FF9800, #F57C00); color: white;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }
        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f); color: white;
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
        }
        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 6px 12px rgba(244, 67, 54, 0.4);
        }

        .conversion-panel {
            background: white; border-radius: 10px; padding: 20px; margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: none;
        }
        .conversion-panel.show { display: block; }
        .conversion-options {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .option-group { display: flex; flex-direction: column; gap: 8px; }
        .option-label { font-weight: 600; color: #495057; }
        .option-select, .option-input {
            padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 8px;
            font-size: 14px; transition: border-color 0.3s ease;
        }
        .option-select:focus, .option-input:focus {
            outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .quality-container { display: flex; align-items: center; gap: 10px; }
        .quality-slider {
            flex: 1; height: 6px; border-radius: 3px; background: #dee2e6;
            outline: none; cursor: pointer;
        }
        .quality-value { font-weight: 600; color: #667eea; min-width: 40px; text-align: center; }

        .progress-container { margin: 20px 0; display: none; }
        .progress-container.show { display: block; }

        /* è½¬æ¢ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
        .converted-results-container {
            margin: 20px 0; display: none;
            background: #f8f9fa; border-radius: 8px; padding: 20px;
        }
        .converted-results-container.show { display: block; }
        .converted-results-container h3 {
            margin: 0 0 15px 0; color: #28a745; text-align: center;
        }

        .converted-results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }

        .converted-item {
            background: white; border-radius: 8px; padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;
        }

        .converted-item img {
            width: 100%; height: 120px; object-fit: cover;
            border-radius: 4px; margin-bottom: 10px;
        }

        .converted-item .filename {
            font-size: 12px; color: #666; margin-bottom: 5px;
            word-break: break-all; max-height: 32px; overflow: hidden;
        }

        .converted-item .fileinfo {
            font-size: 11px; color: #888; margin-bottom: 10px;
        }

        .converted-item .download-btn {
            background: #007bff; color: white; border: none;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
            font-size: 12px; transition: background 0.2s;
        }

        .converted-item .download-btn:hover {
            background: #0056b3;
        }

        .converted-controls {
            text-align: center; padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .converted-controls .btn {
            margin: 0 10px;
        }
        .progress-bar {
            width: 100%; height: 20px; background: #e9ecef; border-radius: 10px;
            overflow: hidden; margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(45deg, #4CAF50, #45a049);
            width: 0%; transition: width 0.3s ease; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 12px;
        }
        .progress-text { text-align: center; color: #495057; font-weight: 500; }

        .stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px; margin: 20px 0; padding: 15px;
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5); border-radius: 10px;
        }
        .stat-item {
            text-align: center; padding: 10px; background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
        }
        .stat-number {
            font-size: 1.8em; font-weight: bold; color: #667eea; display: block;
        }
        .stat-label { font-size: 0.9em; color: #6c757d; margin-top: 5px; }

        .log-container {
            background: #2d3748; color: #e2e8f0; border-radius: 10px; padding: 20px;
            margin: 20px 0; font-family: 'Courier New', monospace; font-size: 14px;
            min-height: 120px; max-height: 300px; overflow-y: auto;
            white-space: pre-wrap; line-height: 1.4;
        }

        .file-input { display: none; }
        .match-indicator {
            position: absolute; top: 5px; left: 5px; background: #28a745; color: white;
            padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold;
        }
        .size-mismatch { background: #dc3545; }
        .unmatched-indicator { background: #dc3545; }
        .size-match-indicator { background: #28a745; }
        .selected-indicator {
            position: absolute; top: -5px; right: -5px;
            background: #667eea; color: white; width: 24px; height: 24px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; z-index: 20;
            border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .main-container { margin: 10px; padding: 15px; }
            .upload-section, .preview-container { grid-template-columns: 1fr; }
            .preview-container { min-height: 500px; }
            .preview-grid { grid-template-columns: repeat(2, 1fr); max-height: 450px; }
            .controls { flex-direction: column; align-items: center; }
            .btn { width: 100%; max-width: 300px; }
            .conversion-options { grid-template-columns: 1fr; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 480px) {
            .preview-container { min-height: 400px; }
            .preview-grid { grid-template-columns: 1fr; max-height: 350px; }
            .image-item img { height: 100px; }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¨ å¤šåŠŸèƒ½å›¾ç‰‡å¤„ç†å·¥å…·é›†</h1>
            <p>OCRæ™ºèƒ½åŒ¹é… + æ ¼å¼è½¬æ¢ + æ‰¹é‡å¤„ç†ï¼Œä¸€ç«™å¼è§£å†³æ–¹æ¡ˆ</p>
        </div>

        <!-- å·¥ä½œæµç¨‹ -->
        <div class="workflow-container">
            <!-- æ­¥éª¤1: ä¸Šä¼ å›¾ç‰‡ -->
            <div class="step-section">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">ğŸ“‚ ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶</div>
                </div>

                <div class="upload-section">
                    <div class="upload-group" id="uploadA">
                        <input type="file" class="file-input" id="aFiles" multiple accept="image/*">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">Aç»„å›¾ç‰‡ï¼ˆå‚è€ƒæ¨¡æ¿ï¼‰</div>
                        <div class="upload-hint">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</div>
                        <div class="file-count" id="aFileCount">æœªé€‰æ‹©æ–‡ä»¶</div>
                    </div>

                    <div class="upload-group" id="uploadB">
                        <input type="file" class="file-input" id="bFiles" multiple accept="image/*">
                        <div class="upload-icon">ğŸ¯</div>
                        <div class="upload-text">Bç»„å›¾ç‰‡ï¼ˆéœ€è¦é‡å‘½åï¼‰</div>
                        <div class="upload-hint">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</div>
                        <div class="file-count" id="bFileCount">æœªé€‰æ‹©æ–‡ä»¶</div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats">
                    <div class="stat-item">
                        <span class="stat-number" id="aCount">0</span>
                        <div class="stat-label">Aç»„å›¾ç‰‡</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="bCount">0</span>
                        <div class="stat-label">Bç»„å›¾ç‰‡</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="matchedCount">0</span>
                        <div class="stat-label">å·²åŒ¹é…</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="unmatchedCount">0</span>
                        <div class="stat-label">æœªåŒ¹é…</div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤2: å›¾ç‰‡é¢„è§ˆå’ŒåŒ¹é… -->
            <div class="step-section">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">ğŸ” OCRè¯†åˆ«ä¸æ™ºèƒ½åŒ¹é…</div>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" id="startOCR">ğŸš€ å¼€å§‹OCRè¯†åˆ«</button>
                    <button class="btn btn-secondary" id="confirmMatch" disabled>âœ… ç¡®è®¤æ‰‹åŠ¨åŒ¹é…</button>
                    <button class="btn btn-danger" id="resetAll">ğŸ”„ é‡ç½®æ‰€æœ‰</button>
                </div>

                <div class="preview-container">
                    <div class="preview-section">
                        <div class="preview-header">
                            <div class="preview-title">ğŸ“ Aç»„å›¾ç‰‡é¢„è§ˆ</div>
                        </div>
                        <div class="preview-grid" id="aPreview">
                            <div style="text-align: center; color: #999; padding: 40px;">è¯·å…ˆä¸Šä¼ Aç»„å›¾ç‰‡</div>
                        </div>
                    </div>

                    <div class="preview-section">
                        <div class="preview-header">
                            <div class="preview-title">ğŸ¯ Bç»„å›¾ç‰‡é¢„è§ˆ</div>
                        </div>
                        <div class="preview-grid" id="bPreview">
                            <div style="text-align: center; color: #999; padding: 40px;">è¯·å…ˆä¸Šä¼ Bç»„å›¾ç‰‡</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ­¥éª¤3: æ ¼å¼è½¬æ¢è®¾ç½® -->
            <div class="step-section">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">ğŸ”„ æ ¼å¼è½¬æ¢ä¸ä¸‹è½½</div>
                </div>

                <div class="controls">
                    <button class="btn btn-secondary" id="showConversionPanel">âš™ï¸ è½¬æ¢è®¾ç½®</button>
                </div>

                <!-- è½¬æ¢è®¾ç½®é¢æ¿ -->
                <div class="conversion-panel" id="conversionPanel">
                    <h3 style="margin-bottom: 20px; color: #333;">ğŸ”„ æ ¼å¼è½¬æ¢è®¾ç½®</h3>

                    <div class="conversion-options">
                        <div class="option-group">
                            <label class="option-label">ç›®æ ‡æ ¼å¼</label>
                            <select class="option-select" id="targetFormat">
                                <option value="jpg">JPG (æ ‡å‡†)</option>
                                <option value="jpg-tiny" selected>JPG-Tiny (é«˜å‹ç¼©)</option>
                                <option value="png">PNG (æ— æŸ)</option>
                                <option value="png-tiny">PNG-Tiny (å‹ç¼©)</option>
                                <option value="webp">WebP (ç°ä»£æ ¼å¼)</option>
                                <option value="avif">AVIF (è¶…é«˜å‹ç¼©)</option>
                                <option value="ico">ICO (å›¾æ ‡)</option>
                            </select>
                        </div>

                        <div class="option-group">
                            <label class="option-label">å‹ç¼©è´¨é‡</label>
                            <div class="quality-container">
                                <input type="range" class="quality-slider" id="qualitySlider"
                                       min="10" max="100" value="80">
                                <div class="quality-value" id="qualityValue">80%</div>
                            </div>
                        </div>

                        <div class="option-group">
                            <label class="option-label">é‡å‘½åè§„åˆ™</label>
                            <select class="option-select" id="renameRule">
                                <option value="original">ä¿æŒåŸå</option>
                                <option value="matched" selected>ä½¿ç”¨åŒ¹é…å</option>
                                <option value="timestamp">æ·»åŠ æ—¶é—´æˆ³</option>
                                <option value="sequential">é¡ºåºç¼–å·</option>
                            </select>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="btn btn-primary" id="startConversion">ğŸš€ å¼€å§‹è½¬æ¢</button>
                        <button class="btn btn-secondary" id="hideConversionPanel">âŒ å–æ¶ˆ</button>
                    </div>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>
                    <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
                </div>

                <!-- è½¬æ¢ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                <div id="convertedResultsContainer" class="converted-results-container">
                    <h3>ğŸ‰ è½¬æ¢å®Œæˆ</h3>
                    <div id="convertedResultsGrid" class="converted-results-grid"></div>
                    <div class="converted-controls">
                        <button class="btn btn-primary" id="downloadAllConverted">ğŸ“¥ ä¸‹è½½å…¨éƒ¨</button>
                        <button class="btn btn-secondary" id="downloadZipConverted">ğŸ“¦ ä¸‹è½½å‹ç¼©åŒ…</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-container" id="logContainer">æ¬¢è¿ä½¿ç”¨å¤šåŠŸèƒ½å›¾ç‰‡å¤„ç†å·¥å…·é›†ï¼

åŠŸèƒ½è¯´æ˜ï¼š
1. ä¸Šä¼ Aç»„ï¼ˆå‚è€ƒæ¨¡æ¿ï¼‰å’ŒBç»„ï¼ˆéœ€è¦é‡å‘½åï¼‰å›¾ç‰‡
2. ç‚¹å‡»"å¼€å§‹OCRè¯†åˆ«"è¿›è¡Œæ–‡å­—è¯†åˆ«å’Œè‡ªåŠ¨åŒ¹é…
3. å¯ä»¥æ‰‹åŠ¨é€‰æ‹©å›¾ç‰‡è¿›è¡ŒåŒ¹é…ï¼ˆéœ€è¦ç›¸åŒå°ºå¯¸ï¼‰
4. é€‰æ‹©è½¬æ¢æ ¼å¼å’Œè´¨é‡ï¼Œæ‰¹é‡ä¸‹è½½å¤„ç†åçš„å›¾ç‰‡

æ³¨æ„ï¼šOCRåŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥ï¼Œå…è´¹APIæœ‰QPSé™åˆ¶ã€‚</div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let aResults = [], bResults = [], selectedA = null, selectedB = null;
        let convertedResults = []; // å­˜å‚¨è½¬æ¢ç»“æœ
        let isProcessing = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            updateStats();
        });

        function initializeEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            document.getElementById('uploadA').addEventListener('click', () => {
                document.getElementById('aFiles').click();
            });

            document.getElementById('uploadB').addEventListener('click', () => {
                document.getElementById('bFiles').click();
            });

            document.getElementById('aFiles').addEventListener('change', (e) => {
                handleFileUpload(e.target.files, 'a');
            });

            document.getElementById('bFiles').addEventListener('change', (e) => {
                handleFileUpload(e.target.files, 'b');
            });

            // æ‹–æ‹½ä¸Šä¼ 
            setupDragAndDrop('uploadA', 'a');
            setupDragAndDrop('uploadB', 'b');

            // æ§åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('startOCR').addEventListener('click', startOCRProcess);
            document.getElementById('confirmMatch').addEventListener('click', confirmMatch);
            document.getElementById('resetAll').addEventListener('click', resetAll);

            document.getElementById('showConversionPanel').addEventListener('click', showConversionPanel);
            document.getElementById('hideConversionPanel').addEventListener('click', hideConversionPanel);
            document.getElementById('startConversion').addEventListener('click', startConversion);
            document.getElementById('downloadAllConverted').addEventListener('click', downloadAllConverted);
            document.getElementById('downloadZipConverted').addEventListener('click', downloadZipConverted);

            // è´¨é‡æ»‘å—äº‹ä»¶
            document.getElementById('qualitySlider').addEventListener('input', function() {
                document.getElementById('qualityValue').textContent = this.value + '%';
            });
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        async function handleFileUpload(files, type) {
            if (!files || files.length === 0) return;

            const results = type === 'a' ? aResults : bResults;
            const newFiles = [];

            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;

                const base64URL = await convertImageToBase64(file);
                const img = new Image();
                await new Promise((resolve) => {
                    img.onload = resolve;
                    img.src = "data:image/jpeg;base64," + base64URL;
                });

                newFiles.push({
                    file: file,
                    url: "data:image/jpeg;base64," + base64URL,
                    text: "",
                    confidence: 0,
                    downloadLink: null,
                    downloadName: file.name,
                    matched: false,
                    width: img.width,
                    height: img.height,
                    resolution: img.width * img.height
                });
            }

            // æ·»åŠ åˆ°ç»“æœæ•°ç»„
            results.push(...newFiles);

            // æ’åºï¼šæŒ‰åˆ†è¾¨ç‡ä»å°åˆ°å¤§ï¼Œç›¸åŒåˆ†è¾¨ç‡æŒ‰åç§°æ’åº
            results.sort((a, b) => {
                if (a.resolution !== b.resolution) {
                    return a.resolution - b.resolution;
                }
                return a.file.name.localeCompare(b.file.name);
            });

            updateFileCount(type);
            renderImages(type);
            updateStats();
            logMessage(`âœ… æˆåŠŸä¸Šä¼  ${newFiles.length} å¼ ${type.toUpperCase()}ç»„å›¾ç‰‡`);
        }

        // æ‹–æ‹½ä¸Šä¼ è®¾ç½®
        function setupDragAndDrop(elementId, type) {
            const element = document.getElementById(elementId);

            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                element.classList.add('drag-over');
            });

            element.addEventListener('dragleave', (e) => {
                if (!element.contains(e.relatedTarget)) {
                    element.classList.remove('drag-over');
                }
            });

            element.addEventListener('drop', async (e) => {
                e.preventDefault();
                element.classList.remove('drag-over');

                const files = Array.from(e.dataTransfer.files).filter(file =>
                    file.type.startsWith('image/')
                );

                if (files.length > 0) {
                    await handleFileUpload(files, type);
                }
            });
        }

        // è½¬æ¢å›¾ç‰‡ä¸ºBase64
        async function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext("2d").drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/jpeg").split(",")[1]);
                };
                img.onerror = reject;
                const reader = new FileReader();
                reader.onload = e => img.src = e.target.result;
                reader.readAsDataURL(file);
            });
        }

        // OCRè¯†åˆ«
        async function ocrImage(file, retryCount = 0) {
            const base64 = await convertImageToBase64(file);
            try {
                const res = await fetch("http://0.0.0.0:3000/ocr", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ imageBase64: base64 })
                });
                const data = await res.json();

                // æ£€æŸ¥QPSé™åˆ¶
                if (data.error_code === 18 || data.error_msg?.includes("qps") ||
                    data.error_msg?.includes("limit")) {
                    if (retryCount < 3) {
                        const waitTime = 5000 * (retryCount + 1);
                        logMessage(`â³ QPSé™åˆ¶ï¼Œç­‰å¾… ${waitTime/1000} ç§’åé‡è¯•... (${retryCount + 1}/3)`);
                        await sleep(waitTime);
                        return await ocrImage(file, retryCount + 1);
                    } else {
                        return { text: "QPSé™åˆ¶ï¼Œè¯·ç¨åé‡è¯•", confidence: 0 };
                    }
                }

                const text = data.words_result?.map(w => w.words).join(" ") || "";
                const confidence = data.words_result?.length > 0 ?
                    data.words_result.reduce((sum, w) => sum + (w.probability || 0.8), 0) /
                    data.words_result.length : 0;

                return { text, confidence: Math.round(confidence * 100) };
            } catch (e) {
                if (retryCount < 2) {
                    logMessage(`âš ï¸ ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•ä¸­... (${retryCount + 1}/2)`);
                    await sleep(1000);
                    return await ocrImage(file, retryCount + 1);
                }
                return { text: "è¯†åˆ«å¤±è´¥", confidence: 0 };
            }
        }

        // å¼€å§‹OCRå¤„ç†
        async function startOCRProcess() {
            if (aResults.length === 0 || bResults.length === 0) {
                alert("è¯·å…ˆä¸Šä¼ Aç»„å’ŒBç»„å›¾ç‰‡ï¼");
                return;
            }

            if (isProcessing) return;
            isProcessing = true;

            const startBtn = document.getElementById('startOCR');
            startBtn.disabled = true;
            startBtn.textContent = "ğŸ”„ å¤„ç†ä¸­...";

            try {
                logMessage("ğŸš€ å¼€å§‹OCRè¯†åˆ«...");
                showProgress(true);

                // è¯†åˆ«Aç»„
                const aToProcess = aResults.filter(r => !r.text || r.text === "");
                if (aToProcess.length > 0) {
                    logMessage(`ğŸ” è¯†åˆ«Aç»„å›¾ç‰‡ (${aToProcess.length}å¼ )...`);

                    for (let i = 0; i < aToProcess.length; i++) {
                        const r = aToProcess[i];
                        updateProgress((i / (aToProcess.length + bResults.length)) * 50,
                                    `è¯†åˆ«Aç»„: ${r.file.name}`);

                        const result = await ocrImage(r.file);
                        r.text = result.text;
                        r.confidence = result.confidence;

                        renderImages('a');
                        await sleep(300);
                    }
                }

                // è¯†åˆ«Bç»„
                const bToProcess = bResults.filter(r => !r.text || r.text === "");
                if (bToProcess.length > 0) {
                    logMessage(`ğŸ” è¯†åˆ«Bç»„å›¾ç‰‡ (${bToProcess.length}å¼ )...`);

                    for (let i = 0; i < bToProcess.length; i++) {
                        const r = bToProcess[i];
                        updateProgress(50 + ((i / bToProcess.length) * 30),
                                    `è¯†åˆ«Bç»„: ${r.file.name}`);

                        const result = await ocrImage(r.file);
                        r.text = result.text;
                        r.confidence = result.confidence;

                        renderImages('b');
                        await sleep(300);
                    }
                }

                // è‡ªåŠ¨åŒ¹é…
                updateProgress(80, "å¼€å§‹è‡ªåŠ¨åŒ¹é…...");
                await autoMatch();

                updateProgress(100, "è¯†åˆ«å®Œæˆï¼");
                logMessage("âœ… OCRè¯†åˆ«å’Œè‡ªåŠ¨åŒ¹é…å®Œæˆï¼");

            } catch (error) {
                logMessage(`âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`);
            } finally {
                isProcessing = false;
                startBtn.disabled = false;
                startBtn.textContent = "ğŸš€ å¼€å§‹OCRè¯†åˆ«";
                setTimeout(() => showProgress(false), 2000);
            }
        }

        // è‡ªåŠ¨åŒ¹é…
        async function autoMatch() {
            const unmatchedB = bResults.filter(b => !b.matched);
            if (unmatchedB.length === 0) return;

            // è°ƒè¯•ï¼šåŒ¹é…å‰çš„Bç»„é¡ºåº
            console.log("è‡ªåŠ¨åŒ¹é…å‰Bç»„é¡ºåº:");
            bResults.forEach((item, index) => {
                console.log(`${index + 1}. ${item.file.name} (${item.width}x${item.height})`);
            });

            logMessage(`ğŸ¤– è‡ªåŠ¨åŒ¹é… ${unmatchedB.length} å¼ æœªåŒ¹é…çš„Bç»„å›¾ç‰‡...`);

            const threshold = 0.5;
            let autoMatchedCount = 0;
            const usedAMatches = new Set();

            // æŒ‰ç…§bResultsçš„åŸå§‹é¡ºåºå¤„ç†æœªåŒ¹é…çš„å›¾ç‰‡ï¼Œä¿æŒé¡ºåºä¸å˜
            for (const b of bResults) {
                // åªå¤„ç†æœªåŒ¹é…çš„å›¾ç‰‡
                if (b.matched || !b.text || b.text.trim() === "" ||
                    b.text === "è¯†åˆ«å¤±è´¥" || b.text === "æœªè¯†åˆ«åˆ°æ–‡å­—") {
                    continue;
                }

                let bestMatch = null;
                let bestSimilarity = 0;

                for (const a of aResults) {
                    if (usedAMatches.has(a) || !a.text || a.text.trim() === "" ||
                        a.text === "è¯†åˆ«å¤±è´¥" || a.text === "æœªè¯†åˆ«åˆ°æ–‡å­—") {
                        continue;
                    }

                    // æ£€æŸ¥å°ºå¯¸åŒ¹é…
                    if (a.width !== b.width || a.height !== b.height) {
                        continue;
                    }

                    const similarity = stringSimilarity.compareTwoStrings(b.text, a.text);
                    if (similarity >= threshold && similarity > bestSimilarity) {
                        bestMatch = a;
                        bestSimilarity = similarity;
                    }
                }

                if (bestMatch) {
                    b.matched = true;
                    b.similarity = bestSimilarity;
                    b.matchedA = bestMatch;
                    usedAMatches.add(bestMatch);

                    const suffix = b.file.name.split(".").pop();
                    const baseName = bestMatch.file.name.split(".")[0];

                    // æ£€æŸ¥Bç»„ä¸­æ˜¯å¦å·²æœ‰ç›¸åŒçš„downloadNameï¼Œé¿å…é‡åå†²çª
                    let newName = baseName + "." + suffix;
                    let counter = 1;

                    while (bResults.some(other => other !== b && other.downloadName === newName)) {
                        newName = `${baseName}_${counter}.${suffix}`;
                        counter++;
                    }

                    b.downloadLink = URL.createObjectURL(b.file);
                    b.downloadName = newName;
                    autoMatchedCount++;
                }
            }

            // è°ƒè¯•ï¼šåŒ¹é…åçš„Bç»„é¡ºåº
            console.log("è‡ªåŠ¨åŒ¹é…åBç»„é¡ºåº:");
            bResults.forEach((item, index) => {
                console.log(`${index + 1}. ${item.file.name} (${item.width}x${item.height}, åŒ¹é…:${item.matched})`);
            });

            renderImages('a');
            renderImages('b');
            updateStats();

            logMessage(`âœ… è‡ªåŠ¨åŒ¹é…å®Œæˆï¼æˆåŠŸåŒ¹é… ${autoMatchedCount} å¼ å›¾ç‰‡`);
            if (autoMatchedCount < unmatchedB.length) {
                logMessage(`â„¹ï¸ è¿˜æœ‰ ${unmatchedB.length - autoMatchedCount} å¼ å›¾ç‰‡éœ€è¦æ‰‹åŠ¨åŒ¹é…`);
            }
        }

        // æ‰‹åŠ¨åŒ¹é…ç¡®è®¤
        function confirmMatch() {
            if (!selectedA || !selectedB) {
                alert("è¯·å…ˆé€‰æ‹©Aç»„å’ŒBç»„çš„å›¾ç‰‡è¿›è¡ŒåŒ¹é…ï¼");
                return;
            }

            if (selectedA.width !== selectedB.width || selectedA.height !== selectedB.height) {
                alert(`å°ºå¯¸ä¸åŒ¹é…ï¼\nAç»„: ${selectedA.width}x${selectedA.height}\nBç»„: ${selectedB.width}x${selectedB.height}\nåªèƒ½åŒ¹é…ç›¸åŒå°ºå¯¸çš„å›¾ç‰‡ï¼`);
                return;
            }

            const suffix = selectedB.file.name.split(".").pop();
            const baseName = selectedA.file.name.split(".")[0];
            const newName = baseName + "." + suffix;

            // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–Bç»„å›¾ç‰‡å·²ä½¿ç”¨ç›¸åŒçš„downloadName
            const conflictingImage = bResults.find(b => b !== selectedB && b.downloadName === newName);

            if (conflictingImage) {
                // å°†å†²çªçš„å›¾ç‰‡é‡ç½®ä¸ºæœªåŒ¹é…çŠ¶æ€
                conflictingImage.matched = false;
                conflictingImage.matchedA = null;
                conflictingImage.downloadName = null;
                conflictingImage.downloadLink = null;
                conflictingImage.similarity = 0;

                logMessage(`âš ï¸ é‡åå†²çªï¼š${conflictingImage.file.name} å·²é‡ç½®ä¸ºæœªåŒ¹é…çŠ¶æ€ï¼Œå¯é‡æ–°åŒ¹é…`);
            }

            selectedB.matched = true;
            selectedB.matchedA = selectedA;
            selectedB.downloadLink = URL.createObjectURL(selectedB.file);
            selectedB.downloadName = newName;
            selectedB.similarity = stringSimilarity.compareTwoStrings(
                selectedB.text || '', selectedA.text || ''
            );

            const originalSelectedB = selectedB;
            selectedA = null;
            selectedB = null;

            renderImages('a');
            renderImages('b');
            updateStats();
            updateMatchButton();

            logMessage(`âœ… æ‰‹åŠ¨åŒ¹é…æˆåŠŸ: ${originalSelectedB.file.name} â†’ ${newName}`);
        }



        // æ˜¾ç¤ºè½¬æ¢é¢æ¿
        function showConversionPanel() {
            const matchedImages = bResults.filter(b => b.matched);
            if (matchedImages.length === 0) {
                alert("è¯·å…ˆè¿›è¡ŒOCRè¯†åˆ«å’ŒåŒ¹é…ï¼Œç„¶åå†è®¾ç½®è½¬æ¢å‚æ•°ï¼");
                return;
            }

            document.getElementById('conversionPanel').classList.add('show');
            logMessage(`âš™ï¸ è½¬æ¢è®¾ç½®é¢æ¿å·²æ‰“å¼€ï¼Œå‡†å¤‡è½¬æ¢ ${matchedImages.length} å¼ å›¾ç‰‡`);
        }

        function hideConversionPanel() {
            document.getElementById('conversionPanel').classList.remove('show');
        }

        // æ‰¹é‡è½¬æ¢æ ¼å¼ï¼ˆä¸è‡ªåŠ¨ä¸‹è½½ï¼‰
        async function batchConvertDownload() {
            const matchedImages = bResults.filter(b => b.matched);
            if (matchedImages.length === 0) {
                alert("æ²¡æœ‰å·²åŒ¹é…çš„å›¾ç‰‡å¯ä»¥è½¬æ¢ï¼");
                return;
            }

            const targetFormat = document.getElementById('targetFormat').value;
            const quality = parseInt(document.getElementById('qualitySlider').value);
            const renameRule = document.getElementById('renameRule').value;

            showProgress(true);
            logMessage(`ğŸ”„ å¼€å§‹æ‰¹é‡è½¬æ¢ ${matchedImages.length} å¼ å›¾ç‰‡ä¸º ${targetFormat.toUpperCase()} æ ¼å¼...`);

            // æ¸…ç©ºä¹‹å‰çš„è½¬æ¢ç»“æœ
            convertedResults = [];

            try {
                for (let i = 0; i < matchedImages.length; i++) {
                    const image = matchedImages[i];
                    updateProgress((i / matchedImages.length) * 100,
                                `è½¬æ¢ä¸­: ${image.file.name}`);

                    const convertedBlob = await convertImage(image.file, targetFormat, quality);
                    if (convertedBlob) {
                        const extension = getFileExtension(targetFormat);
                        let fileName = getConvertedFileName(image, renameRule, extension, i);

                        // å­˜å‚¨è½¬æ¢ç»“æœè€Œä¸æ˜¯ç›´æ¥ä¸‹è½½
                        convertedResults.push({
                            originalImage: image,
                            convertedBlob: convertedBlob,
                            fileName: fileName,
                            format: targetFormat.toUpperCase(),
                            quality: quality,
                            size: convertedBlob.size
                        });

                        logMessage(`âœ… ${fileName} è½¬æ¢å®Œæˆ`);
                    } else {
                        logMessage(`âŒ ${image.file.name} è½¬æ¢å¤±è´¥`);
                    }

                    await sleep(100);
                }

                updateProgress(100, "è½¬æ¢å®Œæˆï¼");
                logMessage(`âœ… æ‰¹é‡è½¬æ¢å®Œæˆï¼${matchedImages.length} å¼ å›¾ç‰‡å·²å‡†å¤‡å¥½ä¸‹è½½`);

                // æ˜¾ç¤ºè½¬æ¢ç»“æœ
                displayConvertedResults();

            } catch (error) {
                logMessage(`âŒ è½¬æ¢å¤±è´¥: ${error.message}`);
            } finally {
                setTimeout(() => showProgress(false), 1000);
            }
        }


        // å¼€å§‹è½¬æ¢ï¼ˆé¢æ¿ä¸­çš„è½¬æ¢æŒ‰é’®ï¼‰
        async function startConversion() {
            hideConversionPanel();
            await batchConvertDownload();
        }

        // æ˜¾ç¤ºè½¬æ¢ç»“æœ
        function displayConvertedResults() {
            if (convertedResults.length === 0) return;

            const container = document.getElementById('convertedResultsContainer');
            const grid = document.getElementById('convertedResultsGrid');

            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            grid.innerHTML = '';

            convertedResults.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'converted-item';

                // åˆ›å»ºå›¾ç‰‡é¢„è§ˆ
                const img = document.createElement('img');
                img.src = URL.createObjectURL(result.convertedBlob);
                img.alt = result.fileName;

                // æ–‡ä»¶å
                const filename = document.createElement('div');
                filename.className = 'filename';
                filename.textContent = result.fileName;

                // æ–‡ä»¶ä¿¡æ¯
                const fileinfo = document.createElement('div');
                fileinfo.className = 'fileinfo';
                const sizeKB = (result.size / 1024).toFixed(1);
                fileinfo.textContent = `${result.format} | ${result.quality}% | ${sizeKB}KB`;

                item.appendChild(img);
                item.appendChild(filename);
                item.appendChild(fileinfo);

                grid.appendChild(item);
            });

            // æ˜¾ç¤ºå®¹å™¨
            container.classList.add('show');
        }

        // ä¸‹è½½å•ä¸ªè½¬æ¢åçš„å›¾ç‰‡
        function downloadSingleConverted(index) {
            if (index >= 0 && index < convertedResults.length) {
                const result = convertedResults[index];
                const downloadUrl = URL.createObjectURL(result.convertedBlob);

                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = result.fileName;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                URL.revokeObjectURL(downloadUrl);
                logMessage(`âœ… ${result.fileName} å·²ä¸‹è½½`);
            }
        }

        // ä¸‹è½½å…¨éƒ¨è½¬æ¢åçš„å›¾ç‰‡
        function downloadAllConverted() {
            if (convertedResults.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„è½¬æ¢ç»“æœï¼');
                return;
            }

            convertedResults.forEach((result, index) => {
                setTimeout(() => {
                    downloadSingleConverted(index);
                }, index * 200); // å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
            });

            logMessage(`âœ… å¼€å§‹ä¸‹è½½å…¨éƒ¨ ${convertedResults.length} å¼ å›¾ç‰‡`);
        }

        // ä¸‹è½½è½¬æ¢ç»“æœçš„ZIPå‹ç¼©åŒ…
        async function downloadZipConverted() {
            if (convertedResults.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„è½¬æ¢ç»“æœï¼');
                return;
            }

            showProgress(true);
            logMessage(`ğŸ“¦ å¼€å§‹æ‰“åŒ… ${convertedResults.length} å¼ è½¬æ¢åçš„å›¾ç‰‡...`);

            try {
                const zip = new JSZip();

                convertedResults.forEach((result, index) => {
                    updateProgress((index / convertedResults.length) * 100,
                                `æ‰“åŒ…ä¸­: ${result.fileName}`);
                    zip.file(result.fileName, result.convertedBlob);
                });

                updateProgress(100, "ç”ŸæˆZIPæ–‡ä»¶...");
                const content = await zip.generateAsync({ type: "blob" });

                const downloadUrl = URL.createObjectURL(content);
                const a = document.createElement("a");
                a.href = downloadUrl;
                a.download = `converted_images_${new Date().toISOString().slice(0,10)}.zip`;
                a.style.display = "none";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                logMessage(`âœ… ZIPå‹ç¼©åŒ…ä¸‹è½½å·²å¼€å§‹ï¼åŒ…å« ${convertedResults.length} å¼ è½¬æ¢åçš„å›¾ç‰‡`);
            } catch (error) {
                logMessage(`âŒ æ‰“åŒ…å¤±è´¥: ${error.message}`);
            } finally {
                setTimeout(() => showProgress(false), 2000);
            }
        }

        // å›¾ç‰‡è½¬æ¢
        async function convertImage(file, targetFormat, quality) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    let mimeType, qualityValue;

                    switch(targetFormat) {
                        case 'jpg':
                        case 'jpg-tiny':
                            mimeType = 'image/jpeg';
                            // ç¡®ä¿è´¨é‡å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
                            qualityValue = Math.max(0.01, Math.min(1.0, quality / 100));
                            break;
                        case 'png':
                        case 'png-tiny':
                            mimeType = 'image/png';
                            // PNGé€šè¿‡é¢„å¤„ç†æ¥å®ç°è´¨é‡æ§åˆ¶
                            qualityValue = undefined;
                            break;
                        case 'webp':
                            mimeType = 'image/webp';
                            // ç¡®ä¿è´¨é‡å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
                            qualityValue = Math.max(0.01, Math.min(1.0, quality / 100));
                            break;
                        case 'avif':
                            // AVIFæ ¼å¼éœ€è¦ç‰¹æ®Šå¤„ç†
                            if (!canvas.toBlob.toString().includes('image/avif')) {
                                // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒAVIFï¼Œå›é€€åˆ°WebP
                                logMessage(`âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒAVIFæ ¼å¼ï¼Œå›é€€åˆ°WebPæ ¼å¼`);
                                mimeType = 'image/webp';
                                qualityValue = quality / 100;
                            } else {
                                mimeType = 'image/avif';
                                // AVIFè´¨é‡å‚æ•°èŒƒå›´é€šå¸¸æ˜¯0-100ï¼Œä½†æŸäº›æµè§ˆå™¨å®ç°å¯èƒ½ä¸åŒ
                                qualityValue = Math.max(0.01, Math.min(1.0, quality / 100));
                            }
                            break;
                        case 'ico':
                            // ICOæ ¼å¼é€šå¸¸ä¸æ”¯æŒè´¨é‡å‚æ•°
                            mimeType = 'image/png'; // ä½¿ç”¨PNGä½œä¸ºICOçš„åŸºç¡€
                            qualityValue = undefined;
                            break;
                        default:
                            mimeType = 'image/jpeg';
                            qualityValue = quality / 100;
                    }

                    // PNGæ ¼å¼è´¨é‡æ§åˆ¶å¤„ç†
                    if (targetFormat === 'png' || targetFormat === 'png-tiny') {
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;

                        // æ ¹æ®è´¨é‡è®¾ç½®è¿›è¡Œå›¾åƒé¢„å¤„ç†
                        if (quality < 100) {
                            // æ–¹æ³•1: é¢œè‰²é‡åŒ– - å‡å°‘é¢œè‰²æ•°é‡
                            const colorReduction = Math.max(1, Math.floor((100 - quality) / 10));
                            const factor = Math.pow(2, colorReduction);

                            for (let i = 0; i < data.length; i += 4) {
                                // é‡åŒ–RGBé€šé“
                                data[i] = Math.floor(data[i] / factor) * factor;       // Red
                                data[i + 1] = Math.floor(data[i + 1] / factor) * factor; // Green
                                data[i + 2] = Math.floor(data[i + 2] / factor) * factor; // Blue
                                // Alphaé€šé“ä¿æŒä¸å˜
                            }

                            // æ–¹æ³•2: å¦‚æœè´¨é‡å¾ˆä½ï¼Œæ·»åŠ è½»å¾®çš„æŠ–åŠ¨
                            if (quality < 50) {
                                for (let i = 0; i < data.length; i += 4) {
                                    const noise = (Math.random() - 0.5) * (50 - quality) / 5;
                                    data[i] = Math.max(0, Math.min(255, data[i] + noise));
                                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise));
                                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise));
                                }
                            }

                            ctx.putImageData(imageData, 0, 0);
                        }

                        // å¯¹äºéå¸¸ä½çš„è´¨é‡ï¼Œå¯ä»¥é™ä½åˆ†è¾¨ç‡
                        if (quality < 30) {
                            const scale = 0.5 + (quality / 30) * 0.5; // 0.5 åˆ° 1.0 çš„ç¼©æ”¾
                            const newWidth = Math.floor(canvas.width * scale);
                            const newHeight = Math.floor(canvas.height * scale);

                            // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œç¼©æ”¾
                            const tempCanvas = document.createElement('canvas');
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCanvas.width = newWidth;
                            tempCanvas.height = newHeight;

                            // ç¼©å°
                            tempCtx.drawImage(canvas, 0, 0, newWidth, newHeight);

                            // é‡æ–°è°ƒæ•´åŸcanvaså¤§å°å¹¶ç»˜åˆ¶å›å»
                            canvas.width = newWidth;
                            canvas.height = newHeight;
                            ctx.drawImage(tempCanvas, 0, 0);
                        }
                    }

                    canvas.toBlob((blob) => {
                        if (blob) {
                            // æ·»åŠ æ–‡ä»¶å¤§å°ä¿¡æ¯åˆ°æ—¥å¿—
                            const sizeKB = (blob.size / 1024).toFixed(1);
                            console.log(`è½¬æ¢å®Œæˆ: ${targetFormat.toUpperCase()}, è´¨é‡: ${quality}%, å¤§å°: ${sizeKB}KB`);
                            resolve(blob);
                        } else {
                            // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨JPEGä½œä¸ºåå¤‡
                            canvas.toBlob((fallbackBlob) => {
                                if (fallbackBlob) {
                                    logMessage(`âš ï¸ ${targetFormat.toUpperCase()}æ ¼å¼è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨JPEGæ ¼å¼`);
                                    resolve(fallbackBlob);
                                } else {
                                    reject(new Error('è½¬æ¢å¤±è´¥'));
                                }
                            }, 'image/jpeg', 0.8);
                        }
                    }, mimeType, qualityValue);
                };

                img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));

                const reader = new FileReader();
                reader.onload = e => img.src = e.target.result;
                reader.readAsDataURL(file);
            });
        }

        // è·å–è½¬æ¢åçš„æ–‡ä»¶å
        function getConvertedFileName(image, renameRule, extension, index) {
            switch (renameRule) {
                case 'original':
                    return image.file.name.split('.')[0] + '.' + extension;
                case 'matched':
                    return image.downloadName.split('.')[0] + '.' + extension;
                case 'timestamp':
                    return `${image.downloadName.split('.')[0]}_${Date.now()}.${extension}`;
                case 'sequential':
                    return `image_${(index + 1).toString().padStart(3, '0')}.${extension}`;
                default:
                    return image.downloadName.split('.')[0] + '.' + extension;
            }
        }

        // è·å–æ–‡ä»¶æ‰©å±•å
        function getFileExtension(format) {
            const extensionMap = {
                'jpg': 'jpg',
                'jpg-tiny': 'jpg',
                'png': 'png',
                'png-tiny': 'png',
                'webp': 'webp',
                'avif': 'avif',
                'ico': 'ico'
            };
            return extensionMap[format] || 'jpg';
        }

        // æ¸²æŸ“å›¾ç‰‡
        function renderImages(type) {
            const results = type === 'a' ? aResults : bResults;
            const container = document.getElementById(type + 'Preview');

            // æ’åºå°†åœ¨ä¸‹é¢çš„ä¸‰çº§æ’åºä¸­ç»Ÿä¸€å¤„ç†

            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        è¯·å…ˆä¸Šä¼ ${type.toUpperCase()}ç»„å›¾ç‰‡
                    </div>
                `;
                return;
            }

            // ä¸‰çº§æ’åºé€»è¾‘ï¼š
            // 1. åŒ¹é…çŠ¶æ€åˆ†ç»„ï¼šæœªåŒ¹é… â†’ å·²åŒ¹é…
            // 2. å°ºå¯¸æ’åºï¼šå°å°ºå¯¸ â†’ å¤§å°ºå¯¸ (åŒç»„å†…)
            // 3. åç§°æ’åºï¼šA â†’ Z (åŒå°ºå¯¸å†…)
            results.sort((a, b) => {
                let aMatched = false, bMatched = false;

                if (type === 'a') {
                    // Aç»„ï¼šæ£€æŸ¥æ˜¯å¦è¢«Bç»„åŒ¹é…
                    aMatched = bResults.some(bItem => bItem.matched && bItem.matchedA === a);
                    bMatched = bResults.some(bItem => bItem.matched && bItem.matchedA === b);
                } else {
                    // Bç»„ï¼šç›´æ¥ä½¿ç”¨matchedå±æ€§
                    aMatched = a.matched;
                    bMatched = b.matched;
                }

                // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šåŒ¹é…çŠ¶æ€åˆ†ç»„ï¼ˆæœªåŒ¹é…çš„åœ¨å‰ï¼‰
                if (!aMatched && bMatched) return -1;
                if (aMatched && !bMatched) return 1;

                // ç¬¬äºŒä¼˜å…ˆçº§ï¼šç›¸åŒåŒ¹é…çŠ¶æ€å†…ï¼ŒæŒ‰åˆ†è¾¨ç‡ä»å°åˆ°å¤§æ’åº
                if (a.resolution !== b.resolution) {
                    return a.resolution - b.resolution;
                }

                // ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šç›¸åŒåˆ†è¾¨ç‡å†…ï¼ŒæŒ‰æ˜¾ç¤ºåç§°å­—æ¯é¡ºåºæ’åº
                // å¯¹äºBç»„å·²åŒ¹é…çš„å›¾ç‰‡ï¼Œä½¿ç”¨downloadNameï¼›æœªåŒ¹é…çš„ä½¿ç”¨åŸå§‹æ–‡ä»¶å
                // å¯¹äºAç»„ï¼Œå§‹ç»ˆä½¿ç”¨åŸå§‹æ–‡ä»¶å
                let aName, bName;

                if (type === 'b') {
                    aName = (aMatched && a.downloadName) ? a.downloadName : a.file.name;
                    bName = (bMatched && b.downloadName) ? b.downloadName : b.file.name;
                } else {
                    aName = a.file.name;
                    bName = b.file.name;
                }

                const nameComparison = aName.localeCompare(bName);

                // è°ƒè¯•ä¿¡æ¯ï¼šåœ¨åŒåˆ†è¾¨ç‡æƒ…å†µä¸‹è¾“å‡ºæ’åºæ¯”è¾ƒ
                if (a.resolution === b.resolution && nameComparison !== 0) {
                    console.log(`${type}ç»„åŒå°ºå¯¸æ’åº: ${aName} vs ${bName} = ${nameComparison} (æ˜¾ç¤ºåç§°)`);
                }

                return nameComparison;
            });

            // éªŒè¯æ’åºç»“æœï¼ˆè°ƒè¯•ç”¨ï¼‰
            if (type === 'b') {
                console.log(`æ¸²æŸ“æ—¶Bç»„æœ€ç»ˆæ’åº:`);
                results.forEach((item, index) => {
                    const displayName = (item.matched && item.downloadName) ? item.downloadName : item.file.name;
                    console.log(`${index + 1}. ${displayName} [åŸå:${item.file.name}] (${item.width}x${item.height}, åŒ¹é…:${item.matched})`);
                });
            }

            container.innerHTML = '';

            results.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'image-item';

                // æ·»åŠ åŒ¹é…çŠ¶æ€æ ·å¼
                let isMatched = false;
                if (type === 'a') {
                    // Aç»„ï¼šæ£€æŸ¥æ˜¯å¦è¢«ä»»ä½•Bç»„å›¾ç‰‡åŒ¹é…
                    isMatched = bResults.some(b => b.matched && b.matchedA === result);
                } else {
                    // Bç»„ï¼šç›´æ¥ä½¿ç”¨matchedå±æ€§
                    isMatched = result.matched;
                }

                if (isMatched) {
                    item.classList.add('matched');
                } else {
                    // å¦‚æœOCRè¯†åˆ«å®Œæˆä½†æœªåŒ¹é…ï¼Œæ·»åŠ æœªåŒ¹é…æ ·å¼
                    if (result.text && result.text.trim() &&
                        result.text !== 'ç­‰å¾…è¯†åˆ«...' && result.text !== 'è¯†åˆ«ä¸­...' &&
                        result.text !== 'è¯†åˆ«å¤±è´¥' && result.text !== 'æœªè¯†åˆ«åˆ°æ–‡å­—') {
                        item.classList.add('unmatched');
                    }
                }

                // æ·»åŠ é€‰ä¸­çŠ¶æ€æ ·å¼
                if ((type === 'a' && result === selectedA) ||
                    (type === 'b' && result === selectedB)) {
                    item.classList.add('selected');
                }

                // æ„å»ºæŒ‡ç¤ºå™¨HTML
                let indicators = '';

                // é€‰ä¸­çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆæœ€ä¼˜å…ˆæ˜¾ç¤ºï¼‰
                if ((type === 'a' && result === selectedA) || (type === 'b' && result === selectedB)) {
                    indicators += '<div class="selected-indicator">âœ“</div>';
                }

                // åŒ¹é…çŠ¶æ€æŒ‡ç¤ºå™¨
                if (isMatched) {
                    indicators += '<div class="match-indicator">å·²åŒ¹é…</div>';
                } else {
                    // æ˜¾ç¤ºæœªåŒ¹é…æŒ‡ç¤ºå™¨ï¼ˆå¯¹Aç»„å’ŒBç»„éƒ½é€‚ç”¨ï¼‰
                    if (result.text && result.text.trim() &&
                        result.text !== 'ç­‰å¾…è¯†åˆ«...' && result.text !== 'è¯†åˆ«ä¸­...' &&
                        result.text !== 'è¯†åˆ«å¤±è´¥' && result.text !== 'æœªè¯†åˆ«åˆ°æ–‡å­—') {
                        indicators += '<div class="match-indicator unmatched-indicator">æœªåŒ¹é…</div>';
                    }
                }

                // å°ºå¯¸åŒ¹é…æŒ‡ç¤ºå™¨ï¼ˆä»…å¯¹Bç»„ä¸”æœ‰é€‰ä¸­çš„Aç»„æ—¶æ˜¾ç¤ºï¼‰
                if (selectedA && type === 'b' && !isMatched) {
                    if (selectedA.width === result.width && selectedA.height === result.height) {
                        indicators += '<div class="match-indicator size-match-indicator" style="top: 25px;">å°ºå¯¸åŒ¹é…</div>';
                    } else {
                        indicators += '<div class="match-indicator size-mismatch" style="top: 25px;">å°ºå¯¸ä¸ç¬¦</div>';
                    }
                }

                item.innerHTML = `
                    <button class="delete-btn" onclick="deleteImage('${type}', ${index})">Ã—</button>
                    ${indicators}
                    <img src="${result.url}" alt="${result.file.name}" onclick="selectImage('${type}', ${index})">
                    <div class="image-filename">${result.downloadName || result.file.name}</div>
                    <div class="image-ocr-text">${result.text || 'ç­‰å¾…è¯†åˆ«...'}</div>
                    <div class="image-resolution">${result.width}Ã—${result.height}</div>
                `;

                container.appendChild(item);
            });
        }

        // é€‰æ‹©å›¾ç‰‡
        function selectImage(type, index) {
            if (type === 'a') {
                selectedA = aResults[index];
                selectedB = null;
            } else {
                selectedB = bResults[index];
            }

            renderImages('a');
            renderImages('b');
            updateMatchButton();

            logMessage(`âœ… å·²é€‰æ‹©${type.toUpperCase()}ç»„å›¾ç‰‡: ${(type === 'a' ? selectedA : selectedB).file.name}`);
        }

        // åˆ é™¤å›¾ç‰‡
        function deleteImage(type, index) {
            if (type === 'a') {
                aResults.splice(index, 1);
                if (selectedA === aResults[index]) selectedA = null;
            } else {
                bResults.splice(index, 1);
                if (selectedB === bResults[index]) selectedB = null;
            }

            updateFileCount(type);
            renderImages(type);
            updateStats();
            updateMatchButton();

            logMessage(`ğŸ—‘ï¸ å·²åˆ é™¤${type.toUpperCase()}ç»„å›¾ç‰‡`);
        }

        // æ›´æ–°æ–‡ä»¶è®¡æ•°
        function updateFileCount(type) {
            const count = (type === 'a' ? aResults : bResults).length;
            document.getElementById(type + 'FileCount').textContent =
                count > 0 ? `å·²é€‰æ‹© ${count} å¼ å›¾ç‰‡` : 'æœªé€‰æ‹©æ–‡ä»¶';
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('aCount').textContent = aResults.length;
            document.getElementById('bCount').textContent = bResults.length;
            const matched = bResults.filter(b => b.matched).length;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('unmatchedCount').textContent = bResults.length - matched;
        }

        // æ›´æ–°åŒ¹é…æŒ‰é’®çŠ¶æ€
        function updateMatchButton() {
            const confirmBtn = document.getElementById('confirmMatch');
            const canMatch = selectedA && selectedB &&
                            selectedA.width === selectedB.width &&
                            selectedA.height === selectedB.height;

            confirmBtn.disabled = !canMatch;
            confirmBtn.style.opacity = canMatch ? '1' : '0.5';
        }

        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰ä¸Šä¼ çš„å›¾ç‰‡å’ŒåŒ¹é…ç»“æœã€‚')) {
                aResults = [];
                bResults = [];
                selectedA = null;
                selectedB = null;

                updateFileCount('a');
                updateFileCount('b');
                renderImages('a');
                renderImages('b');
                updateStats();
                updateMatchButton();
                hideConversionPanel();
                showProgress(false);

                document.getElementById('logContainer').textContent =
                    'âœ… æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹ä½¿ç”¨ã€‚';
            }
        }

        // æ˜¾ç¤º/éšè—è¿›åº¦æ¡
        function showProgress(show) {
            const container = document.getElementById('progressContainer');
            container.classList.toggle('show', show);
            if (!show) {
                updateProgress(0, '');
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent, text) {
            const fill = document.getElementById('progressFill');
            const textEl = document.getElementById('progressText');

            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
            textEl.textContent = text;
        }

        // æ—¥å¿—æ¶ˆæ¯
        function logMessage(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.textContent += `\n[${timestamp}] ${message}`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // å·¥å…·å‡½æ•°
        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }
    </script>
</body>
</html>
