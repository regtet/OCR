<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>OCRåŒ¹é…ä¸‹è½½å·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-container {
            max-width: 100%;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        h2 {
            text-align: center;
            color: #333;
            margin: 0 0 10px 0;
            font-size: 1.5em;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .comparison-layout {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .group {
            flex: 1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .group h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .group h3::before {
            content: '';
            width: 3px;
            height: 16px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        #clearBBtn {
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(45deg, #ff9a9e, #ff6a88);
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(255, 105, 135, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #clearBBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 105, 135, 0.35);
        }

        #clearBBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        label {
            font-weight: 600;
            display: block;
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1em;
        }

        input[type="file"] {
            margin-bottom: 15px;
            padding: 10px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        input[type="file"]:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            border-radius: 10px;
            background: #fff;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            min-height: 0;
            transition: all 0.3s ease;
        }

        .container.drag-over {
            background: #e3f2fd;
            border: 2px dashed #2196F3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }



        .container::-webkit-scrollbar {
            width: 8px;
        }

        .container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 350px;
            max-height: 400px;
            overflow: hidden;
        }

        .item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .item.selected {
            border-color: #FF5722;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 87, 34, 0.3);
        }

        img {
            width: 100%;
            height: 200px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            object-fit: contain;
            background: #f8f9fa;
            transition: transform 0.3s ease;
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            max-width: 100%;
            max-height: 200px;
        }

        .item:hover img {
            transform: scale(1.02);
        }

        p {
            margin: 4px 0;
            font-size: 12px;
            text-align: center;
            word-break: break-word;
            color: #495057;
            line-height: 1.4;
            min-height: 35px;
            max-height: 60px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            cursor: help;
        }

        .filename {
            margin: 4px 0;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            padding: 6px 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            word-break: break-all;
            line-height: 1.3;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filename.matched {
            color: #28a745;
            background: #d4edda;
        }

        .filename.unmatched {
            color: #dc3545;
            background: #f8d7da;
        }

        .name-resolution-container {
            margin: 4px 0;
            padding: 6px 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            word-break: break-all;
            line-height: 1.3;
            min-height: 35px;
        }

        .name-resolution-container.matched {
            color: #28a745;
            background: #d4edda;
        }

        .name-resolution-container.unmatched {
            color: #dc3545;
            background: #f8d7da;
        }

        .filename-text {
            flex: 1;
            text-align: left;
            margin-right: 8px;
        }

        .resolution-text {
            font-size: 10px;
            color: #6c757d;
            font-style: italic;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.7);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }


        .delete-button {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(255, 255, 255, 0.95);
            color: #6c757d;
            border: 1px solid #dee2e6;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 15;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .item:hover .delete-button {
            display: flex;
        }

        .delete-button:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            transform: scale(1.05);
        }

        .size-match-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .size-match-indicator.match {
            background: #28a745;
        }

        .size-match-indicator.no-match {
            background: #dc3545;
        }


        .confidence-score {
            font-size: 12px;
            color: #28a745;
            margin: 4px 0;
            font-weight: bold;
            text-align: center;
            background: #e8f5e8;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .confidence-score.low {
            color: #dc3545;
        }

        .confidence-score.medium {
            color: #ffc107;
        }




        .file-input-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .select-btn {
            padding: 10px 20px;
            font-size: 14px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .select-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }

        .file-count {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .usage-tips {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }

        .usage-tips h4 {
            margin: 0 0 10px 0;
            color: #1976D2;
            font-size: 16px;
        }

        .usage-tips p {
            margin: 5px 0;
            color: #424242;
            font-size: 14px;
            line-height: 1.5;
        }


        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 10px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .controls button:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .image-preview-content {
            max-width: 98%;
            max-height: 98%;
            position: relative;
            cursor: default;
        }

        .image-preview-content img {
            max-width: 100%;
            max-height: 75vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .image-preview-info {
            position: absolute;
            bottom: -100px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            max-height: 80px;
            overflow: visible;
        }

        .image-preview-info h3 {
            margin: 0 0 6px 0;
            font-size: 16px;
        }

        .image-preview-info p {
            margin: 2px 0;
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.3;
        }

        .close-preview {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-preview:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        button {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-width: 120px;
        }

        #startBtn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: #fff;
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        #startBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }

        #confirmBtn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: #fff;
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3);
            opacity: 0.5;
        }

        #confirmBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(33, 150, 243, 0.4);
        }

        #forceMatchBtn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: #fff;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
            opacity: 0.5;
        }

        #forceMatchBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.4);
        }

        #batchDownloadBtn {
            background: linear-gradient(45deg, #00BCD4, #0097A7);
            color: #fff;
            box-shadow: 0 4px 8px rgba(0, 188, 212, 0.3);
        }

        #batchDownloadBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 188, 212, 0.4);
        }

        #zipDownloadBtn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: #fff;
            box-shadow: 0 4px 8px rgba(156, 39, 176, 0.3);
        }

        #zipDownloadBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(156, 39, 176, 0.4);
        }

        #resetBtn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: #fff;
            box-shadow: 0 4px 8px rgba(244, 67, 54, 0.3);
        }

        #resetBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(244, 67, 54, 0.4);
        }

        a.download-link {
            display: block;
            margin-top: 8px;
            font-size: 11px;
            text-decoration: none;
            color: #007bff;
            padding: 4px 8px;
            background: #e3f2fd;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        a.download-link:hover {
            background: #bbdefb;
            color: #0056b3;
        }

        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #495057;
            min-height: 50px;
            white-space: pre-wrap;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 5px 0;
            padding: 6px 12px;
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
            border-radius: 15px;
            font-size: 13px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-number {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .comparison-layout {
                flex-direction: column;
                height: auto;
                min-height: 400px;
            }

            .group {
                min-height: 300px;
            }

            .container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                max-height: 400px;
            }

            .item {
                min-height: 280px;
            }

            img {
                height: 120px;
            }

            p {
                font-size: 12px;
                max-height: 60px;
                -webkit-line-clamp: 3;
                line-clamp: 3;
            }

            .filename {
                font-size: 12px;
                min-height: 35px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
                max-width: 300px;
            }

            .stats {
                flex-wrap: wrap;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <h2>OCRåŒ¹é…ä¸‹è½½å·¥å…·</h2>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="aCount">0</div>
                <div class="stat-label">Aç»„å›¾ç‰‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="bCount">0</div>
                <div class="stat-label">Bç»„å›¾ç‰‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="matchedCount">0</div>
                <div class="stat-label">å·²åŒ¹é…</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="unmatchedCount">0</div>
                <div class="stat-label">æœªåŒ¹é…</div>
            </div>
        </div>

        <div class="controls">
            <label
                style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:#fff;border-radius:10px;border:1px solid #e0e0e0;">
                ç›¸ä¼¼åº¦é˜ˆå€¼
                <input id="thresholdInput" type="range" min="0" max="1" step="0.01" value="0.75" style="width:160px;">
                <span id="thresholdValue"
                    style="min-width:36px;text-align:right;font-weight:700;color:#667eea;">0.75</span>
            </label>
            <label
                style="display:flex;align-items:center;gap:8px;padding:6px 12px;background:#fff;border-radius:10px;border:1px solid #e0e0e0;">
                QPSé™åˆ¶(æ¯ç§’è¯·æ±‚æ•°)
                <input id="qpsInput" type="range" min="1" max="10" step="1" value="6" style="width:160px;">
                <span id="qpsValue" style="min-width:24px;text-align:right;font-weight:700;color:#9C27B0;">6</span>
            </label>
            <button id="startBtn">ğŸš€ å¼€å§‹è¯†åˆ«å¹¶è‡ªåŠ¨åŒ¹é…</button>
            <button id="confirmBtn" disabled>âœ… ç¡®è®¤æ‰‹åŠ¨åŒ¹é…</button>
            <button id="forceMatchBtn" disabled>âš ï¸ å¼ºåˆ¶åŒ¹é…</button>
            <button id="batchDownloadBtn">ğŸ“¥ æ‰¹é‡å•å¼ ä¸‹è½½</button>
            <button id="zipDownloadBtn">ğŸ“¦ æ‰¹é‡ZIPä¸‹è½½</button>
            <button id="resetBtn">ğŸ”„ é‡ç½®</button>
        </div>

        <div class="comparison-layout">
            <div class="group">
                <h3>ğŸ“ Aç»„å›¾ç‰‡ï¼ˆå‚è€ƒæ¨¡æ¿ï¼‰</h3>
                <div class="file-input-section">
                    <input type="file" id="aFiles" multiple accept="image/*" style="display: none;">
                    <button id="selectAImages" class="select-btn">ğŸ“‚ é€‰æ‹©Aç»„å›¾ç‰‡</button>
                    <span id="aFileCount" class="file-count">æœªé€‰æ‹©æ–‡ä»¶</span>
                </div>
                <div id="aPreview" class="container">
                </div>
            </div>

            <div class="group">
                <div class="group-header">
                    <h3>ğŸ¯ Bç»„å›¾ç‰‡ï¼ˆéœ€è¦é‡å‘½åï¼‰</h3>
                    <button id="clearBBtn" type="button">ğŸ§¹ æ¸…ç©ºBç»„</button>
                </div>
                <div class="file-input-section">
                    <input type="file" id="bFiles" multiple accept="image/*" style="display: none;">
                    <button id="selectBImages" class="select-btn">ğŸ“‚ é€‰æ‹©Bç»„å›¾ç‰‡</button>
                    <span id="bFileCount" class="file-count">æœªé€‰æ‹©æ–‡ä»¶</span>
                </div>
                <div id="bPreview" class="container">
                </div>
            </div>
        </div>



        <div id="log"></div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/string-similarity@4.0.4/umd/string-similarity.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script>
        // ============================================================
        // API æœåŠ¡å™¨åœ°å€é…ç½®ï¼ˆè‡ªåŠ¨é€‚é…æœ¬åœ°å’Œç”Ÿäº§ç¯å¢ƒï¼‰
        // ============================================================
        const API_BASE_URL = (() => {
            // æ–¹å¼1: å¦‚æœæ˜¯ä»æœåŠ¡å™¨è®¿é—®ï¼ˆhttp://æˆ–https://ï¼‰ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
            if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                // å‡è®¾å‰ç«¯å’Œåç«¯åœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Š
                const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');

                // å¦‚æœé€šè¿‡ 3000 ç«¯å£è®¿é—®ï¼ˆç›´æ¥è®¿é—®åç«¯ï¼‰
                if (port === '3000') {
                    return `${window.location.protocol}//${window.location.hostname}:3000`;
                }

                // å¦‚æœé€šè¿‡å…¶ä»–ç«¯å£è®¿é—®ï¼ˆå¦‚ Nginx ä»£ç†ï¼‰ï¼Œåç«¯åœ¨ 3000 ç«¯å£
                return `${window.location.protocol}//${window.location.hostname}:3000`;
            }

            // æ–¹å¼2: å¦‚æœæ˜¯æœ¬åœ° file:// æ‰“å¼€
            // é»˜è®¤ä½¿ç”¨ localhostï¼ˆæœ¬åœ°å¼€å‘ï¼‰
            // return 'http://localhost:3000';

            // å¦‚æœè¦è¿æ¥è¿œç¨‹æœåŠ¡å™¨ï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šå¹¶ä¿®æ”¹IPï¼š
            return 'http://117.72.99.159:3000';
        })();

        console.log(`ğŸ“¡ APIæœåŠ¡å™¨åœ°å€: ${API_BASE_URL}`);

        // ============================================================

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms))
        }

        async function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext("2d").drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/jpeg").split(",")[1])
                };
                img.onerror = reject;
                const reader = new FileReader();
                reader.onload = e => img.src = e.target.result;
                reader.readAsDataURL(file)
            })
        }

        async function ocrImage(file, retryCount = 0) {
            const base64 = await convertImageToBase64(file);
            try {
                const res = await fetch(`${API_BASE_URL}/ocr`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ imageBase64: base64 })
                });
                const data = await res.json();

                // æ£€æŸ¥æ˜¯å¦æ˜¯QPSé™åˆ¶é”™è¯¯
                if (data.error_code === 18 || data.error_msg?.includes("qps") || data.error_msg?.includes("limit") || data.error_msg?.includes("Open api qps request limit reached")) {
                    if (retryCount < 5) {
                        const waitTime = 5000 * (retryCount + 1); // 5ç§’ã€10ç§’ã€15ç§’ã€20ç§’ã€25ç§’
                        console.log(`QPSé™åˆ¶ï¼Œç­‰å¾… ${waitTime / 1000} ç§’åé‡è¯•... (${retryCount + 1}/5)`);
                        await sleep(waitTime);
                        return await ocrImage(file, retryCount + 1);
                    } else {
                        return { text: "QPSé™åˆ¶ï¼Œè¯·ç¨åé‡è¯•", confidence: 0 };
                    }
                }

                const text = data.words_result?.map(w => w.words).join(" ") || "";
                const confidence = data.words_result?.length > 0 ?
                    data.words_result.reduce((sum, w) => sum + (w.probability || 0.8), 0) / data.words_result.length : 0;
                // å¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°æ–‡å­—ï¼Œæ˜ç¡®æ ‡è®°
                return {
                    text: text || "æœªè¯†åˆ«åˆ°æ–‡å­—",
                    confidence: Math.round(confidence * 100)
                };
            } catch (e) {
                if (retryCount < 2) {
                    console.log(`ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•ä¸­... (${retryCount + 1}/2)`);
                    await sleep(300);
                    return await ocrImage(file, retryCount + 1);
                }
                return { text: "è¯†åˆ«å¤±è´¥", confidence: 0 };
            }
        }

        // ============================================================
        // æ¿€è¿›å¹¶å‘ç­–ç•¥ï¼šæ¯ä¸ªKeyç‹¬ç«‹è®¡æ—¶ï¼Œæ¯ç§’å‘2ä¸ªè¯·æ±‚
        // ============================================================
        const KEY_COUNT = 3;  // API Key æ•°é‡
        const QPS_PER_KEY = 2;  // æ¯ä¸ªKeyæ¯ç§’çš„è¯·æ±‚æ•°
        const TOTAL_QPS = KEY_COUNT * QPS_PER_KEY;  // æ€»QPS = 6

        // è®°å½•æ¯ä¸ªæ‰¹æ¬¡çš„å‘é€æ—¶é—´
        const batchTimestamps = [];
        let currentBatchIndex = 0;

        async function takeRateSlot() {
            const now = Date.now();

            // è®¡ç®—å½“å‰åº”è¯¥åœ¨ç¬¬å‡ æ‰¹ï¼ˆæ¯ç§’ä¸€æ‰¹ï¼Œæ¯æ‰¹6ä¸ªè¯·æ±‚ï¼‰
            const currentSecond = Math.floor(now / 1000);

            // æ¸…ç†è¶…è¿‡2ç§’çš„æ—§è®°å½•
            while (batchTimestamps.length > 0 && now - batchTimestamps[0] > 2000) {
                batchTimestamps.shift();
            }

            // æ£€æŸ¥å½“å‰ç§’å†…æ˜¯å¦å·²ç»å‘é€äº†6ä¸ªè¯·æ±‚
            const requestsInCurrentSecond = batchTimestamps.filter(t =>
                Math.floor(t / 1000) === currentSecond
            ).length;

            if (requestsInCurrentSecond < TOTAL_QPS) {
                // è¿˜å¯ä»¥å‘é€
                batchTimestamps.push(now);
                return;
            }

            // éœ€è¦ç­‰å¾…åˆ°ä¸‹ä¸€ç§’
            const nextSecond = (currentSecond + 1) * 1000;
            const waitTime = nextSecond - now;
            if (waitTime > 0) {
                await sleep(waitTime);
            }

            // é‡æ–°å°è¯•
            return takeRateSlot();
        }

        async function runWithConcurrency(tasks, limit, worker) {
            const results = new Array(tasks.length);
            let nextIndex = 0;
            let running = 0;
            return new Promise((resolve) => {
                const launchNext = () => {
                    while (running < limit && nextIndex < tasks.length) {
                        const current = nextIndex++;
                        running++;
                        Promise.resolve(worker(tasks[current], current))
                            .then((res) => { results[current] = res; })
                            .catch(() => { results[current] = undefined; })
                            .finally(() => {
                                running--;
                                if (nextIndex >= tasks.length && running === 0) {
                                    resolve(results);
                                } else {
                                    launchNext();
                                }
                            });
                    }
                };
                launchNext();
            });
        }

        function updateStats() {
            document.getElementById('aCount').textContent = aResults.length;
            document.getElementById('bCount').textContent = bResults.length;
            const matched = bResults.filter(b => b.matched).length;
            const unmatched = bResults.length - matched;
            document.getElementById('matchedCount').textContent = matched;
            document.getElementById('unmatchedCount').textContent = unmatched;
        }

        // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
        function showImagePreview(imageData, type) {
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            modal.onclick = () => closeImagePreview(modal);

            const content = document.createElement('div');
            content.className = 'image-preview-content';
            content.onclick = (e) => e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            const img = document.createElement('img');
            img.src = imageData.url;
            img.alt = imageData.file.name;

            const info = document.createElement('div');
            info.className = 'image-preview-info';

            const groupName = type === 'a' ? 'Aç»„ï¼ˆå‚è€ƒæ¨¡æ¿ï¼‰' : 'Bç»„ï¼ˆéœ€è¦é‡å‘½åï¼‰';
            const matchStatus = imageData.matched ? 'âœ… å·²åŒ¹é…' : 'âŒ æœªåŒ¹é…';
            const downloadName = imageData.downloadName || imageData.file.name;

            info.innerHTML = `
                <h3>${groupName} - ${imageData.file.name}</h3>
                <p><strong>çŠ¶æ€ï¼š</strong>${matchStatus}</p>
                <p><strong>å°ºå¯¸ï¼š</strong>${imageData.width} Ã— ${imageData.height}</p>
                <p><strong>OCRæ–‡æœ¬ï¼š</strong>${imageData.text || 'æœªè¯†åˆ«'}</p>
                <p><strong>ç½®ä¿¡åº¦ï¼š</strong>${imageData.confidence || 0}%</p>
                <p><strong>é‡å‘½åï¼š</strong>${downloadName}</p>
                ${imageData.similarity ? `<p><strong>ç›¸ä¼¼åº¦ï¼š</strong>${Math.round(imageData.similarity * 100)}%</p>` : ''}
            `;

            const closeBtn = document.createElement('button');
            closeBtn.className = 'close-preview';
            closeBtn.innerHTML = 'Ã—';
            closeBtn.onclick = () => closeImagePreview(modal);

            content.appendChild(img);
            content.appendChild(info);
            content.appendChild(closeBtn);
            modal.appendChild(content);
            document.body.appendChild(modal);

            // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    closeImagePreview(modal);
                }
            };
            document.addEventListener('keydown', handleKeyPress);
            modal._keyHandler = handleKeyPress;
        }

        function closeImagePreview(modal) {
            if (modal && modal.parentNode) {
                modal.parentNode.removeChild(modal);
                if (modal._keyHandler) {
                    document.removeEventListener('keydown', modal._keyHandler);
                }
            }
        }

        function renderImages(container, results, type) {
            container.innerHTML = "";

            // ç»Ÿä¸€çš„æ’åºé€»è¾‘ï¼šå·²åŒ¹é…çš„åœ¨å‰ï¼ŒæœªåŒ¹é…çš„åœ¨åï¼ŒæŒ‰å°ºå¯¸å’Œåç§°æ’åº
            results.sort((a, b) => {
                let aMatched = false, bMatched = false;

                if (type === "a") {
                    // Aç»„ï¼šæ£€æŸ¥æ˜¯å¦è¢«ä»»ä½•Bç»„å›¾ç‰‡åŒ¹é…
                    aMatched = bResults.some(bItem => bItem.matched && bItem.matchedA === a);
                    bMatched = bResults.some(bItem => bItem.matched && bItem.matchedA === b);
                } else {
                    // Bç»„ï¼šç›´æ¥ä½¿ç”¨matchedå±æ€§
                    aMatched = a.matched;
                    bMatched = b.matched;
                }

                // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šå·²åŒ¹é…çš„åœ¨å‰ï¼ŒæœªåŒ¹é…çš„åœ¨å
                if (aMatched && !bMatched) return -1;  // aå·²åŒ¹é… â†’ æ’å‰é¢
                if (!aMatched && bMatched) return 1;   // aæœªåŒ¹é… â†’ æ’åé¢

                // ç¬¬äºŒä¼˜å…ˆçº§ï¼šæŒ‰åˆ†è¾¨ç‡ä»å°åˆ°å¤§æ’åº
                if (a.resolution !== b.resolution) {
                    return a.resolution - b.resolution;
                }

                // ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šä½¿ç”¨downloadNameè¿›è¡Œæ’åºï¼Œå¦‚æœæ²¡æœ‰downloadNameåˆ™ä½¿ç”¨file.name
                const aName = a.downloadName || a.file.name;
                const bName = b.downloadName || b.file.name;
                const nameComparison = aName.localeCompare(bName);
                if (nameComparison !== 0) {
                    return nameComparison;
                }

                // ç¬¬å››ä¼˜å…ˆçº§ï¼šæŒ‰ä¸Šä¼ é¡ºåºæ’åºï¼ˆä¿æŒç›¸å¯¹é¡ºåºç¨³å®šï¼‰
                return (a.uploadIndex || 0) - (b.uploadIndex || 0);
            });

            results.forEach(r => {
                const div = document.createElement("div");
                div.classList.add("item");
                div.draggable = false; // ç¦ç”¨å›¾ç‰‡é¡¹çš„æ‹–æ‹½ï¼Œé¿å…ä¸å®¹å™¨æ‹–æ‹½å†²çª
                div.dataset.type = type;
                div.dataset.index = results.indexOf(r);

                const img = document.createElement("img");
                img.src = r.url;
                img.title = `OCR: ${r.text}\nå³å°†é‡å‘½å: ${r.downloadName}\nåˆ†è¾¨ç‡: ${r.width}x${r.height}\nç½®ä¿¡åº¦: ${r.confidence || 0}%`;
                img.ondblclick = (e) => {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘é€‰æ‹©äº‹ä»¶
                    showImagePreview(r, type);
                };

                const p = document.createElement("p");
                // æ˜¾ç¤ºOCRè¯†åˆ«ç»“æœï¼Œå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
                if (!r.text || r.text === "") {
                    p.textContent = "ç­‰å¾…è¯†åˆ«...";
                } else {
                    p.textContent = r.text;
                }

                const nameResolutionContainer = document.createElement("div");
                nameResolutionContainer.className = "name-resolution-container";

                const nameSpan = document.createElement("span");
                nameSpan.className = "filename-text";
                nameSpan.textContent = r.downloadName || r.file.name;

                const resolutionSpan = document.createElement("span");
                resolutionSpan.className = "resolution-text";
                resolutionSpan.textContent = `${r.width}x${r.height}`;

                nameResolutionContainer.appendChild(nameSpan);
                nameResolutionContainer.appendChild(resolutionSpan);

                // ä¿®å¤Aç»„å’ŒBç»„çš„çŠ¶æ€æ˜¾ç¤º
                if (type === "a") {
                    // Aç»„ï¼šæ£€æŸ¥æ˜¯å¦è¢«ä»»ä½•Bç»„å›¾ç‰‡åŒ¹é…
                    const isMatched = bResults.some(b => b.matched && b.matchedA === r);
                    nameResolutionContainer.classList.add(isMatched ? "matched" : "unmatched");
                } else {
                    // Bç»„ï¼šæ ¹æ®æ˜¯å¦åŒ¹é…æ˜¾ç¤ºçŠ¶æ€
                    nameResolutionContainer.classList.add(r.matched ? "matched" : "unmatched");
                }

                // æ·»åŠ åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-button";
                deleteBtn.innerHTML = "Ã—";
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (type === "a") {
                        const index = aResults.indexOf(r);
                        if (index > -1) {
                            aResults.splice(index, 1);
                            renderImages(document.getElementById("aPreview"), aResults, "a");
                            document.getElementById("aFileCount").textContent = `å·²é€‰æ‹© ${aResults.length} å¼ å›¾ç‰‡`;
                            enableSingleSelect(); // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                        }
                    } else {
                        const index = bResults.indexOf(r);
                        if (index > -1) {
                            bResults.splice(index, 1);
                            renderImages(document.getElementById("bPreview"), bResults, "b");
                            document.getElementById("bFileCount").textContent = `å·²é€‰æ‹© ${bResults.length} å¼ å›¾ç‰‡`;
                            enableSingleSelect(); // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                        }
                    }
                    updateStats();
                };
                div.appendChild(deleteBtn);





                div.appendChild(img);
                div.appendChild(p);
                div.appendChild(nameResolutionContainer);

                // æ·»åŠ å°ºå¯¸åŒ¹é…æŒ‡ç¤ºå™¨
                if (type === "b" && selectedA) {
                    const sizeMatch = (selectedA.width === r.width && selectedA.height === r.height);
                    const sizeIndicator = document.createElement("div");
                    sizeIndicator.className = "size-match-indicator";
                    sizeIndicator.classList.add(sizeMatch ? "match" : "no-match");
                    sizeIndicator.textContent = sizeMatch ? "å°ºå¯¸åŒ¹é…" : "å°ºå¯¸ä¸ç¬¦";
                    div.appendChild(sizeIndicator);
                }

                if (r.matched && type === "b") {
                    const a = document.createElement("a");
                    a.href = "#";
                    a.download = r.downloadName || r.file.name;
                    a.textContent = "ä¸‹è½½";
                    a.className = "download-link";
                    a.addEventListener("click", (e) => {
                        e.preventDefault();
                        try {
                            // é‡æ–°åˆ›å»º downloadLinkï¼Œé¿å… URL è¿‡æœŸ
                            const downloadLink = URL.createObjectURL(r.file);
                            const downloadA = document.createElement("a");
                            downloadA.href = downloadLink;
                            downloadA.download = r.downloadName || r.file.name;
                            downloadA.style.display = "none";
                            document.body.appendChild(downloadA);
                            downloadA.click();
                            setTimeout(() => {
                                document.body.removeChild(downloadA);
                                URL.revokeObjectURL(downloadLink);
                            }, 100);
                        } catch (error) {
                            console.error("å•å¼ ä¸‹è½½å¤±è´¥:", error);
                            alert("ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
                        }
                    });
                    div.appendChild(a)
                }

                container.appendChild(div);
                r.domDiv = div;
                r.domP = p;
                r.domNameP = nameResolutionContainer;
            });

        }

        async function handleFiles(inputEl, containerEl, type) {
            if (!inputEl || !inputEl.files) return [];
            let files = Array.from(inputEl.files);

            // åŸºäºç°æœ‰ç»“æœè¿›è¡Œè¿½åŠ ï¼Œè€Œä¸æ˜¯æ¯æ¬¡é‡ç½®
            const results = (type === "a" ? aResults : bResults).slice();
            const currentMaxIndex = results.length > 0 ? Math.max(...results.map(r => r.uploadIndex || 0)) : -1;

            for (let i = 0; i < files.length; i++) {
                const f = files[i];
                const base64URL = await convertImageToBase64(f);
                // è·å–å›¾ç‰‡åˆ†è¾¨ç‡
                const img = new Image();
                await new Promise((resolve) => {
                    img.onload = resolve;
                    img.src = "data:image/jpeg;base64," + base64URL;
                });

                results.push({
                    file: f,
                    url: "data:image/jpeg;base64," + base64URL,
                    text: "",
                    downloadLink: null,
                    downloadName: f.name,
                    matched: false,
                    width: img.width,
                    height: img.height,
                    resolution: img.width * img.height,
                    uploadIndex: currentMaxIndex + i + 1  // æ·»åŠ ä¸Šä¼ é¡ºåºç´¢å¼•
                })
            }

            // æŒ‰åˆ†è¾¨ç‡ä»å°åˆ°å¤§æ’åºï¼Œåˆ†è¾¨ç‡ç›¸åŒæ—¶æŒ‰åç§°æ’åºï¼Œå†æŒ‰ä¸Šä¼ é¡ºåº
            results.sort((a, b) => {
                if (a.resolution !== b.resolution) {
                    return a.resolution - b.resolution;
                }
                const nameComparison = a.file.name.localeCompare(b.file.name);
                if (nameComparison !== 0) {
                    return nameComparison;
                }
                return (a.uploadIndex || 0) - (b.uploadIndex || 0);
            });

            // å›å†™åˆ°å…¨å±€å¹¶æ¸²æŸ“
            if (type === "a") {
                aResults = results;
            } else {
                bResults = results;
            }

            renderImages(containerEl, results, type);
            updateStats();
            return results
        }

        let aResults = [], bResults = [], selectedA = null, selectedB = null;
        let ocrDoneOnce = false;

        function getCurrentThreshold() {
            const el = document.getElementById("thresholdInput");
            const val = parseFloat(el && el.value ? el.value : "0.5");
            return isNaN(val) ? 0.5 : val;
        }

        function hasValidText(item) {
            return item && item.text && item.text.trim() && item.text !== "è¯†åˆ«å¤±è´¥" && item.text !== "æœªè¯†åˆ«åˆ°æ–‡å­—";
        }

        function clearPreviousAutoMatches() {
            bResults.forEach(b => {
                if (b.autoMatched) {
                    // release A usage only if no other B points to it
                    const prevA = b.matchedA;
                    b.matched = false;
                    b.downloadLink = null;
                    b.downloadName = b.file.name;
                    b.matchedA = null;
                    b.autoMatched = false;
                    // do not touch manualMatched flag here
                    if (prevA) {
                        const stillUsed = bResults.some(otherB => otherB !== b && otherB.matched && otherB.matchedA === prevA);
                        if (!stillUsed) {
                            prevA.matched = bResults.some(otherB => otherB.matched && otherB.matchedA === prevA);
                        }
                    }
                }
            });
        }

        function recomputeAutoMatchingFromThreshold() {
            if (!ocrDoneOnce) return; // only active after OCR run

            const threshold = getCurrentThreshold();

            // Build a set of A images already occupied by manual matches
            const usedAMatches = new Set();
            bResults.forEach(b => {
                if (b.matched && b.manualMatched && b.matchedA) {
                    usedAMatches.add(b.matchedA);
                }
            });

            // Clear previous auto matches to re-evaluate
            clearPreviousAutoMatches();

            // Re-run auto match for currently unmatched B only
            bResults.forEach(b => {
                if (b.matched) return; // keep manual matches
                if (!hasValidText(b)) return;

                let bestMatch = null;
                let bestSimilarity = 0;

                aResults.forEach(a => {
                    if (usedAMatches.has(a)) return;
                    if (!hasValidText(a)) return;
                    if (!(a.width === b.width && a.height === b.height)) return;

                    const similarity = stringSimilarity.compareTwoStrings(b.text, a.text);
                    if (similarity >= threshold && similarity > bestSimilarity) {
                        bestMatch = a;
                        bestSimilarity = similarity;
                    }
                });

                if (bestMatch) {
                    b.matched = true;
                    b.similarity = bestSimilarity;
                    b.autoMatched = true;
                    b.matchedA = bestMatch;
                    usedAMatches.add(bestMatch);
                    const suffix = b.file.name.split(".").pop();
                    const newName = bestMatch.file.name.split(".")[0] + "." + suffix;
                    const link = URL.createObjectURL(b.file);
                    b.downloadLink = link;
                    b.downloadName = newName;
                }
            });

            // Re-render to reflect new states
            renderImages(document.getElementById("aPreview"), aResults, "a");
            renderImages(document.getElementById("bPreview"), bResults, "b");
            enableSingleSelect();
            updateStats();
        }

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById("aFiles").addEventListener("change", async () => {
            aResults = await handleFiles(document.getElementById("aFiles"), document.getElementById("aPreview"), "a");
            document.getElementById("aFileCount").textContent = `å·²é€‰æ‹© ${aResults.length} å¼ å›¾ç‰‡`;
        });

        document.getElementById("bFiles").addEventListener("change", async () => {
            bResults = await handleFiles(document.getElementById("bFiles"), document.getElementById("bPreview"), "b");
            document.getElementById("bFileCount").textContent = `å·²é€‰æ‹© ${bResults.length} å¼ å›¾ç‰‡`;
        });

        // é€‰æ‹©æŒ‰é’®äº‹ä»¶
        document.getElementById("selectAImages").addEventListener("click", () => {
            document.getElementById("aFiles").click();
        });

        document.getElementById("selectBImages").addEventListener("click", () => {
            document.getElementById("bFiles").click();
        });

        document.getElementById("clearBBtn").addEventListener("click", () => {
            const logEl = document.getElementById("log");

            if (bResults.length === 0) {
                if (logEl) {
                    logEl.textContent = "â„¹ï¸ å½“å‰æ²¡æœ‰Bç»„å›¾ç‰‡ï¼Œæ— éœ€æ¸…ç©ºã€‚\n";
                }
                return;
            }

            bResults.forEach(b => {
                if (b.downloadLink) {
                    try {
                        URL.revokeObjectURL(b.downloadLink);
                    } catch (e) {
                        console.warn("é‡Šæ”¾URLå¤±è´¥", e);
                    }
                }
            });

            bResults = [];
            selectedB = null;

            const bPreviewEl = document.getElementById("bPreview");
            if (bPreviewEl) bPreviewEl.innerHTML = "";

            const bFilesEl = document.getElementById("bFiles");
            if (bFilesEl) bFilesEl.value = "";

            const bCountEl = document.getElementById("bFileCount");
            if (bCountEl) bCountEl.textContent = "æœªé€‰æ‹©æ–‡ä»¶";

            updateStats();
            enableSingleSelect();
            updateSelection();

            if (logEl) {
                logEl.textContent = "ğŸ§¹ å·²æ¸…ç©ºBç»„ä¸Šä¼ çš„æ‰€æœ‰å›¾ç‰‡ã€‚\n";
            }
        });

        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ï¼ˆåªç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼Œä¸å½±å“å›¾ç‰‡åŒ¹é…ï¼‰
        function setupDragAndDrop(containerId, inputId, type) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            container.addEventListener('dragover', (e) => {
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»å¤–éƒ¨æ‹–æ‹½çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸æ˜¯ä»å®¹å™¨å†…éƒ¨æ‹–æ‹½
                if (e.dataTransfer.types.includes('Files') && !e.target.closest('.item')) {
                    e.preventDefault();
                    container.classList.add('drag-over');
                }
            });

            container.addEventListener('dragleave', (e) => {
                // åªæœ‰å½“ç¦»å¼€å®¹å™¨æœ¬èº«æ—¶æ‰ç§»é™¤æ ·å¼
                if (!container.contains(e.relatedTarget)) {
                    container.classList.remove('drag-over');
                }
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                container.classList.remove('drag-over');

                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»å¤–éƒ¨æ‹–æ‹½çš„æ–‡ä»¶ï¼Œå¹¶ä¸”ä¸æ˜¯ä»å®¹å™¨å†…éƒ¨æ‹–æ‹½
                const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                if (files.length > 0 && !e.target.closest('.item')) {
                    // åˆ›å»ºFileListå¯¹è±¡
                    const dataTransfer = new DataTransfer();
                    files.forEach(file => dataTransfer.items.add(file));
                    input.files = dataTransfer.files;

                    // è§¦å‘changeäº‹ä»¶
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
        }

        // è®¾ç½®Aç»„å’ŒBç»„çš„æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        setupDragAndDrop('aPreview', 'aFiles', 'a');
        setupDragAndDrop('bPreview', 'bFiles', 'b');


        function enableSingleSelect() {
            aResults.forEach(a => {
                a.domDiv.onclick = () => {
                    selectedA = (selectedA === a) ? null : a;
                    updateSelection()
                }
            });
            bResults.forEach(b => {
                b.domDiv.onclick = () => {
                    selectedB = (selectedB === b) ? null : b;
                    updateSelection()
                }
            });

        }

        function updateSelection() {
            aResults.forEach(a => a.domDiv.classList.toggle("selected", a === selectedA));
            bResults.forEach(b => b.domDiv.classList.toggle("selected", b === selectedB));

            // æ— è®ºæ˜¯å¦é€‰æ‹©Aï¼Œéƒ½é‡æ–°æ¸²æŸ“Bç»„ï¼Œä»¥åŠ¨æ€æ˜¾ç¤ºæˆ–éšè—å°ºå¯¸åŒ¹é…æŒ‡ç¤ºå™¨
            renderImages(document.getElementById("bPreview"), bResults, "b");
            // é‡æ–°ç»‘å®šBç»„å›¾ç‰‡çš„ç‚¹å‡»äº‹ä»¶ï¼ˆæ”¯æŒäºŒæ¬¡ç‚¹å‡»å–æ¶ˆé€‰ä¸­ï¼‰
            bResults.forEach(b => {
                b.domDiv.onclick = () => {
                    selectedB = (selectedB === b) ? null : b;
                    updateSelection()
                }
            });
            // æ¢å¤Bç»„å›¾ç‰‡çš„é€‰ä¸­çŠ¶æ€
            bResults.forEach(b => b.domDiv.classList.toggle("selected", b === selectedB));

            // æ›´æ–°ç¡®è®¤æŒ‰é’®å’Œå¼ºåˆ¶åŒ¹é…æŒ‰é’®çŠ¶æ€ï¼ˆäº’æ–¥ï¼‰
            const confirmBtn = document.getElementById("confirmBtn");
            const forceMatchBtn = document.getElementById("forceMatchBtn");

            if (confirmBtn && forceMatchBtn) {
                const hasSelection = selectedA && selectedB;
                const sizeMatch = hasSelection &&
                    selectedA.width === selectedB.width &&
                    selectedA.height === selectedB.height;

                if (hasSelection) {
                    if (sizeMatch) {
                        // å°ºå¯¸åŒ¹é…ï¼šå¯ç”¨"ç¡®è®¤æ‰‹åŠ¨åŒ¹é…"ï¼Œç¦ç”¨"å¼ºåˆ¶åŒ¹é…"
                        confirmBtn.disabled = false;
                        confirmBtn.style.opacity = "1";
                        forceMatchBtn.disabled = true;
                        forceMatchBtn.style.opacity = "0.5";
                    } else {
                        // å°ºå¯¸ä¸åŒ¹é…ï¼šç¦ç”¨"ç¡®è®¤æ‰‹åŠ¨åŒ¹é…"ï¼Œå¯ç”¨"å¼ºåˆ¶åŒ¹é…"
                        confirmBtn.disabled = true;
                        confirmBtn.style.opacity = "0.5";
                        forceMatchBtn.disabled = false;
                        forceMatchBtn.style.opacity = "1";
                    }
                } else {
                    // æœªé€‰æ‹©ï¼šä¸¤ä¸ªæŒ‰é’®éƒ½ç¦ç”¨
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = "0.5";
                    forceMatchBtn.disabled = true;
                    forceMatchBtn.style.opacity = "0.5";
                }
            }
        }

        document.getElementById("startBtn").addEventListener("click", async () => {
            const logEl = document.getElementById("log");
            logEl.textContent = "å¼€å§‹OCRè¯†åˆ«...\næ³¨æ„ï¼šå…è´¹ç‰ˆAPIæœ‰QPSé™åˆ¶ï¼Œè¯·è€å¿ƒç­‰å¾…\n";

            // åªè¯†åˆ«è¿˜æ²¡æœ‰OCRç»“æœæˆ–ä¸Šæ¬¡è¯†åˆ«å¤±è´¥/æœªè¯†åˆ«åˆ°æ–‡å­—çš„å›¾ç‰‡
            let aToProcess = aResults.filter(r => !r.text || r.text === "" || r.text === "è¯†åˆ«å¤±è´¥" || r.text === "æœªè¯†åˆ«åˆ°æ–‡å­—");
            let bToProcess = bResults.filter(r => !r.text || r.text === "" || r.text === "è¯†åˆ«å¤±è´¥" || r.text === "æœªè¯†åˆ«åˆ°æ–‡å­—");

            const totalA = aToProcess.length;
            const totalB = bToProcess.length;
            let doneA = 0;
            let doneB = 0;

            if (totalA + totalB > 0) {
                logEl.textContent = `æ‰¹æ¬¡è¯†åˆ«ä¸­ (A:${totalA} B:${totalB})ï¼Œæ¯ç§’6å¼ ...\n`;
                const allTasks = [
                    ...aToProcess.map(item => ({ group: 'a', item })),
                    ...bToProcess.map(item => ({ group: 'b', item }))
                ];

                // æ‰¹æ¬¡å‘é€ç­–ç•¥ï¼šæ¯ç§’å‘é€6ä¸ªï¼Œä¸ç­‰å¾…è¿”å›
                const BATCH_SIZE = 6;  // æ¯æ‰¹6ä¸ªï¼ˆ3ä¸ªKey Ã— 2ä¸ªè¯·æ±‚ï¼‰
                const BATCH_INTERVAL = 1000;  // æ¯ç§’ä¸€æ‰¹

                let batchIndex = 0;
                const startTime = Date.now();

                // æŒ‰æ‰¹æ¬¡å¤„ç†
                while (batchIndex * BATCH_SIZE < allTasks.length) {
                    const batchStartIndex = batchIndex * BATCH_SIZE;
                    const batchEndIndex = Math.min(batchStartIndex + BATCH_SIZE, allTasks.length);
                    const batchTasks = allTasks.slice(batchStartIndex, batchEndIndex);

                    // è®¡ç®—åº”è¯¥åœ¨ç¬¬å‡ ç§’å‘é€è¿™ä¸€æ‰¹
                    const targetTime = startTime + (batchIndex * BATCH_INTERVAL);
                    const now = Date.now();
                    const waitTime = targetTime - now;

                    // å¦‚æœè¿˜æ²¡åˆ°æ—¶é—´ï¼Œç­‰å¾…
                    if (waitTime > 0) {
                        await sleep(waitTime);
                    }

                    // åŒæ—¶å‘é€è¿™ä¸€æ‰¹çš„æ‰€æœ‰è¯·æ±‚ï¼ˆä¸ç­‰å¾…è¿”å›ï¼‰
                    batchTasks.forEach(async (task) => {
                        try {
                            const target = task.item;
                            const result = await ocrImage(target.file);
                            target.text = result.text;
                            target.confidence = result.confidence;
                            if (target.domP) {
                                target.domP.textContent = (target.text && target.text.trim()) ? target.text : "æœªè¯†åˆ«åˆ°æ–‡å­—";
                            }
                            if (task.group === 'a') {
                                doneA++;
                            } else {
                                doneB++;
                            }
                            logEl.textContent = `Aç»„è¿›åº¦: ${doneA}/${totalA}  Bç»„è¿›åº¦: ${doneB}/${totalB}\n`;
                        } catch (err) {
                            console.error('è¯†åˆ«å¤±è´¥:', err);
                        }
                    });

                    logEl.textContent = `å·²å‘é€æ‰¹æ¬¡ ${batchIndex + 1}/${Math.ceil(allTasks.length / BATCH_SIZE)}ï¼Œç­‰å¾…ç»“æœè¿”å›...\nAç»„è¿›åº¦: ${doneA}/${totalA}  Bç»„è¿›åº¦: ${doneB}/${totalB}\n`;
                    batchIndex++;
                }

                // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆï¼ˆç»™ä¸ªåˆç†çš„è¶…æ—¶æ—¶é—´ï¼‰
                const maxWaitTime = Math.ceil(allTasks.length / BATCH_SIZE) * BATCH_INTERVAL + 5000;
                const checkInterval = setInterval(() => {
                    if (doneA + doneB >= allTasks.length) {
                        clearInterval(checkInterval);
                    }
                }, 100);

                // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆæˆ–è¶…æ—¶
                await new Promise((resolve) => {
                    const timeout = setTimeout(() => {
                        clearInterval(checkInterval);
                        resolve();
                    }, maxWaitTime);

                    const check = setInterval(() => {
                        if (doneA + doneB >= allTasks.length) {
                            clearTimeout(timeout);
                            clearInterval(check);
                            resolve();
                        }
                    }, 100);
                });
            }

            // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºç½®ä¿¡åº¦
            renderImages(document.getElementById("aPreview"), aResults, "a");
            renderImages(document.getElementById("bPreview"), bResults, "b");

            // è‡ªåŠ¨åŒ¹é…ï¼šåªåŒ¹é…è¿˜æ²¡æœ‰æ‰‹åŠ¨åŒ¹é…è¿‡çš„Bç»„å›¾ç‰‡
            const unmatchedB = bResults.filter(b => !b.matched);
            if (unmatchedB.length > 0) {
                logEl.textContent = `è‡ªåŠ¨åŒ¹é…æœªåŒ¹é…çš„Bç»„å›¾ç‰‡ (${unmatchedB.length}å¼ )...\n`;

                const threshold = getCurrentThreshold();
                let autoMatchedCount = 0;
                let skippedCount = 0;

                // ç”¨äºè®°å½•å·²ç»è¢«åŒ¹é…çš„Aç»„å›¾ç‰‡ï¼Œé¿å…é‡å¤åŒ¹é…
                const usedAMatches = new Set();

                unmatchedB.forEach(b => {
                    let bestMatch = null;
                    let bestSimilarity = 0;

                    // æ£€æŸ¥Bç»„å›¾ç‰‡æ˜¯å¦OCRè¯†åˆ«æˆåŠŸ
                    const bHasValidText = b.text && b.text.trim() && b.text !== "è¯†åˆ«å¤±è´¥" && b.text !== "æœªè¯†åˆ«åˆ°æ–‡å­—";
                    if (!bHasValidText) {
                        skippedCount++;
                        return; // Bç»„å›¾ç‰‡OCRè¯†åˆ«å¤±è´¥ï¼Œè·³è¿‡è‡ªåŠ¨åŒ¹é…
                    }

                    aResults.forEach(a => {
                        // æ£€æŸ¥Aç»„å›¾ç‰‡æ˜¯å¦å·²ç»è¢«å…¶ä»–Bç»„å›¾ç‰‡åŒ¹é…
                        if (usedAMatches.has(a)) return; // Aç»„å›¾ç‰‡å·²è¢«ä½¿ç”¨ï¼Œè·³è¿‡

                        // æ£€æŸ¥Aç»„å›¾ç‰‡æ˜¯å¦OCRè¯†åˆ«æˆåŠŸ
                        const aHasValidText = a.text && a.text.trim() && a.text !== "è¯†åˆ«å¤±è´¥" && a.text !== "æœªè¯†åˆ«åˆ°æ–‡å­—";
                        if (!aHasValidText) return; // Aç»„å›¾ç‰‡OCRè¯†åˆ«å¤±è´¥ï¼Œè·³è¿‡

                        // æ£€æŸ¥å°ºå¯¸æ˜¯å¦åŒ¹é…
                        const sizeMatch = (a.width === b.width && a.height === b.height);
                        if (!sizeMatch) return; // å°ºå¯¸ä¸åŒ¹é…åˆ™è·³è¿‡

                        const similarity = stringSimilarity.compareTwoStrings(b.text, a.text);
                        if (similarity >= threshold && similarity > bestSimilarity) {
                            bestMatch = a;
                            bestSimilarity = similarity;
                        }
                    });

                    if (bestMatch) {
                        b.matched = true;
                        b.similarity = bestSimilarity;
                        b.autoMatched = true; // æ ‡è®°ä¸ºè‡ªåŠ¨åŒ¹é…
                        b.matchedA = bestMatch; // è®°å½•åŒ¹é…çš„Aç»„å›¾ç‰‡
                        usedAMatches.add(bestMatch); // æ ‡è®°Aç»„å›¾ç‰‡å·²è¢«ä½¿ç”¨
                        const a = bestMatch;
                        const suffix = b.file.name.split(".").pop();
                        const newName = a.file.name.split(".")[0] + "." + suffix;
                        const link = URL.createObjectURL(b.file);
                        b.downloadLink = link;
                        b.downloadName = newName;
                        autoMatchedCount++;
                    }
                });

                // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºåŒ¹é…è´¨é‡ï¼ˆä¼šè‡ªåŠ¨æŒ‰æ–°è§„åˆ™æ’åºï¼‰
                renderImages(document.getElementById("aPreview"), aResults, "a");
                renderImages(document.getElementById("bPreview"), bResults, "b");

                const remainingUnmatched = unmatchedB.length - autoMatchedCount - skippedCount;
                let logMessage = `è¯†åˆ«å®Œæˆï¼è‡ªåŠ¨åŒ¹é…äº† ${autoMatchedCount} å¼ å›¾ç‰‡`;
                if (skippedCount > 0) {
                    logMessage += `ï¼Œè·³è¿‡äº† ${skippedCount} å¼ OCRè¯†åˆ«å¤±è´¥çš„å›¾ç‰‡`;
                }
                if (remainingUnmatched > 0) {
                    logMessage += `ï¼Œè¿˜æœ‰ ${remainingUnmatched} å¼ éœ€è¦æ‰‹åŠ¨åŒ¹é…`;
                }
                logMessage += `ã€‚\nå·²åŒ¹é…çš„å›¾ç‰‡å·²æ’åœ¨å‰è¾¹ï¼ŒæŒ‰å°ºå¯¸ä»å°åˆ°å¤§æ˜¾ç¤ºã€‚`;
                logEl.textContent = logMessage;
            } else {
                logEl.textContent = "è¯†åˆ«å®Œæˆï¼æ‰€æœ‰Bç»„å›¾ç‰‡éƒ½å·²åŒ¹é…ã€‚";
            }

            enableSingleSelect();
            updateStats();
            ocrDoneOnce = true;
        });

        document.getElementById("confirmBtn").addEventListener("click", () => {
            if (!selectedA || !selectedB) {
                alert("è¯·å…ˆé€‰æ‹©Aç»„å’ŒBç»„çš„å›¾ç‰‡è¿›è¡ŒåŒ¹é…ï¼");
                return;
            }

            const a = selectedA, b = selectedB;

            // æ£€æŸ¥å°ºå¯¸æ˜¯å¦åŒ¹é…
            const sizeMatch = (a.width === b.width && a.height === b.height);
            if (!sizeMatch) {
                alert(`å°ºå¯¸ä¸åŒ¹é…ï¼\nAç»„å›¾ç‰‡: ${a.width}x${a.height}\nBç»„å›¾ç‰‡: ${b.width}x${b.height}\nåªæœ‰åŒå°ºå¯¸çš„å›¾ç‰‡æ‰èƒ½åŒ¹é…ï¼`);
                return;
            }

            // å¦‚æœBç»„å›¾ç‰‡å·²ç»åŒ¹é…è¿‡ï¼Œå…ˆæ¸…é™¤ä¹‹å‰çš„åŒ¹é…å…³ç³»
            if (b.matched && b.matchedA) {
                // æ¸…é™¤ä¹‹å‰Aç»„å›¾ç‰‡çš„åŒ¹é…çŠ¶æ€
                const previousA = b.matchedA;
                // æ£€æŸ¥è¿™ä¸ªAç»„å›¾ç‰‡æ˜¯å¦è¿˜è¢«å…¶ä»–Bç»„å›¾ç‰‡åŒ¹é…
                const stillMatched = bResults.some(otherB => otherB.matched && otherB.matchedA === previousA && otherB !== b);
                if (!stillMatched) {
                    // å¦‚æœæ²¡æœ‰å…¶ä»–Bç»„å›¾ç‰‡åŒ¹é…è¿™ä¸ªAç»„å›¾ç‰‡ï¼Œæ¸…é™¤Aç»„å›¾ç‰‡çš„åŒ¹é…çŠ¶æ€
                    previousA.matched = false;
                }
            }

            const suffix = b.file.name.split(".").pop();
            const newName = a.file.name.split(".")[0] + "." + suffix;
            const link = URL.createObjectURL(b.file);

            // è®¡ç®—ç›¸ä¼¼åº¦
            const similarity = stringSimilarity.compareTwoStrings(b.text || '', a.text || '');

            // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–Bç»„å›¾ç‰‡ä½¿ç”¨äº†ç›¸åŒçš„é‡å‘½å
            const duplicateB = bResults.find(otherB =>
                otherB !== b &&
                otherB.downloadName === newName &&
                otherB.matched
            );

            if (duplicateB) {
                // å¦‚æœå‘ç°é‡å¤åç§°ï¼Œè¯´æ˜è‡ªåŠ¨è¯†åˆ«é”™è¯¯ï¼Œé‡å‘½åä¸ºå…¶ä»–åå­—å¹¶å½’ç±»åˆ°æœªåŒ¹é…
                const duplicateSuffix = duplicateB.file.name.split(".").pop();
                const duplicateNewName = `unmatched_${Date.now()}_${duplicateB.file.name}`;

                duplicateB.matched = false;
                duplicateB.downloadName = duplicateNewName;
                duplicateB.downloadLink = null;
                duplicateB.matchedA = null;
                duplicateB.autoMatched = false;
                duplicateB.manualMatched = false;

                // æ¸…é™¤å¯¹åº”Aç»„å›¾ç‰‡çš„åŒ¹é…çŠ¶æ€
                if (duplicateB.matchedA) {
                    const duplicateA = duplicateB.matchedA;
                    const stillMatched = bResults.some(otherB =>
                        otherB.matched && otherB.matchedA === duplicateA && otherB !== duplicateB
                    );
                    if (!stillMatched) {
                        duplicateA.matched = false;
                    }
                }
            }

            b.downloadLink = link;
            b.downloadName = newName;
            b.matched = true;
            b.similarity = similarity;
            b.manualMatched = true; // æ ‡è®°ä¸ºæ‰‹åŠ¨åŒ¹é…
            b.matchedA = a; // è®°å½•åŒ¹é…çš„Aç»„å›¾ç‰‡
            a.matched = true;

            // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºåŒ¹é…çŠ¶æ€ï¼ˆä¼šè‡ªåŠ¨æŒ‰æ–°è§„åˆ™æ’åºï¼‰
            renderImages(document.getElementById("aPreview"), aResults, "a");
            renderImages(document.getElementById("bPreview"), bResults, "b");

            selectedA = null;
            selectedB = null;
            updateSelection(); // æ›´æ–°é€‰æ‹©çŠ¶æ€ï¼Œæ¸…é™¤é«˜äº®
            enableSingleSelect(); // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
            updateStats();

            // æ›´æ–°æ—¥å¿—
            const logEl = document.getElementById("log");
            const action = b.autoMatched ? "é‡æ–°åŒ¹é…" : "æ‰‹åŠ¨åŒ¹é…";
            let logMessage = `âœ… ${action}æˆåŠŸï¼\nBç»„: ${b.file.name} â†’ ${newName}\nå°ºå¯¸: ${a.width}x${a.height}\nç›¸ä¼¼åº¦: ${Math.round(similarity * 100)}%`;

            if (duplicateB) {
                logMessage += `\nâš ï¸ å‘ç°é‡å¤åç§°ï¼Œå·²é‡å‘½åå¹¶å½’ç±»åˆ°æœªåŒ¹é…: ${duplicateB.file.name} â†’ ${duplicateB.downloadName}`;
            }

            logMessage += `\nå·²åŒ¹é…çš„å›¾ç‰‡å·²æ’åœ¨å‰è¾¹ï¼ŒæŒ‰å°ºå¯¸ä»å°åˆ°å¤§æ˜¾ç¤ºã€‚`;
            logEl.textContent = logMessage;
        });

        // å¼ºåˆ¶åŒ¹é…æŒ‰é’®äº‹ä»¶ï¼ˆæ— è§†å°ºå¯¸é™åˆ¶ï¼‰
        document.getElementById("forceMatchBtn").addEventListener("click", () => {
            if (!selectedA || !selectedB) {
                alert("è¯·å…ˆé€‰æ‹©Aç»„å’ŒBç»„çš„å›¾ç‰‡è¿›è¡ŒåŒ¹é…ï¼");
                return;
            }

            const a = selectedA, b = selectedB;

            // å¦‚æœBç»„å›¾ç‰‡å·²ç»åŒ¹é…è¿‡ï¼Œå…ˆæ¸…é™¤ä¹‹å‰çš„åŒ¹é…å…³ç³»
            if (b.matched && b.matchedA) {
                const previousA = b.matchedA;
                const stillMatched = bResults.some(otherB => otherB.matched && otherB.matchedA === previousA && otherB !== b);
                if (!stillMatched) {
                    previousA.matched = false;
                }
            }

            const suffix = b.file.name.split(".").pop();
            const newName = a.file.name.split(".")[0] + "." + suffix;
            const link = URL.createObjectURL(b.file);

            // è®¡ç®—ç›¸ä¼¼åº¦
            const similarity = stringSimilarity.compareTwoStrings(b.text || '', a.text || '');

            // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–Bç»„å›¾ç‰‡ä½¿ç”¨äº†ç›¸åŒçš„é‡å‘½å
            const duplicateB = bResults.find(otherB =>
                otherB !== b &&
                otherB.downloadName === newName &&
                otherB.matched
            );

            if (duplicateB) {
                const duplicateNewName = `unmatched_${Date.now()}_${duplicateB.file.name}`;
                duplicateB.matched = false;
                duplicateB.downloadName = duplicateNewName;
                duplicateB.downloadLink = null;
                duplicateB.matchedA = null;
                duplicateB.autoMatched = false;
                duplicateB.manualMatched = false;

                if (duplicateB.matchedA) {
                    const duplicateA = duplicateB.matchedA;
                    const stillMatched = bResults.some(otherB =>
                        otherB.matched && otherB.matchedA === duplicateA && otherB !== duplicateB
                    );
                    if (!stillMatched) {
                        duplicateA.matched = false;
                    }
                }
            }

            b.downloadLink = link;
            b.downloadName = newName;
            b.matched = true;
            b.similarity = similarity;
            b.manualMatched = true;
            b.forceMatched = true; // æ ‡è®°ä¸ºå¼ºåˆ¶åŒ¹é…
            b.matchedA = a;
            a.matched = true;

            // é‡æ–°æ¸²æŸ“
            renderImages(document.getElementById("aPreview"), aResults, "a");
            renderImages(document.getElementById("bPreview"), bResults, "b");

            selectedA = null;
            selectedB = null;
            updateSelection();
            enableSingleSelect();
            updateStats();

            // æ›´æ–°æ—¥å¿—
            const logEl = document.getElementById("log");
            let logMessage = `âš ï¸ å¼ºåˆ¶åŒ¹é…æˆåŠŸï¼\nBç»„: ${b.file.name} â†’ ${newName}\nAç»„å°ºå¯¸: ${a.width}x${a.height}\nBç»„å°ºå¯¸: ${b.width}x${b.height}\nç›¸ä¼¼åº¦: ${Math.round(similarity * 100)}%`;

            if (duplicateB) {
                logMessage += `\nâš ï¸ å‘ç°é‡å¤åç§°ï¼Œå·²é‡å‘½åå¹¶å½’ç±»åˆ°æœªåŒ¹é…: ${duplicateB.file.name} â†’ ${duplicateB.downloadName}`;
            }

            logMessage += `\n\nâš ï¸ æ³¨æ„ï¼šæ­¤å›¾ç‰‡ä¸ºå¼ºåˆ¶åŒ¹é…ï¼Œå°ºå¯¸ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸ï¼`;
            logMessage += `\nå·²åŒ¹é…çš„å›¾ç‰‡å·²æ’åœ¨å‰è¾¹ï¼ŒæŒ‰å°ºå¯¸ä»å°åˆ°å¤§æ˜¾ç¤ºã€‚`;
            logEl.textContent = logMessage;
        });

        document.getElementById("batchDownloadBtn").addEventListener("click", async () => {
            const matchedResults = bResults.filter(b => b.matched);
            if (matchedResults.length === 0) {
                alert("æ²¡æœ‰å·²åŒ¹é…çš„å›¾ç‰‡å¯ä»¥ä¸‹è½½ï¼");
                return;
            }

            console.log(`å¼€å§‹æ‰¹é‡ä¸‹è½½ ${matchedResults.length} å¼ å›¾ç‰‡...`);

            // ä½¿ç”¨å»¶è¿Ÿä¸‹è½½é¿å…æµè§ˆå™¨é™åˆ¶
            for (let i = 0; i < matchedResults.length; i++) {
                const b = matchedResults[i];

                try {
                    // é‡æ–°åˆ›å»º downloadLinkï¼Œé¿å… URL è¿‡æœŸ
                    const downloadLink = URL.createObjectURL(b.file);

                    const a = document.createElement("a");
                    a.href = downloadLink;
                    a.download = b.downloadName || `matched_${i + 1}.${b.file.name.split('.').pop()}`;
                    a.style.display = "none";
                    document.body.appendChild(a);

                    // è§¦å‘ä¸‹è½½
                    a.click();

                    // æ¸…ç†
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadLink);
                    }, 100);

                    // æ¯å¼ å›¾ç‰‡é—´éš” 200msï¼Œé¿å…æµè§ˆå™¨é™åˆ¶
                    if (i < matchedResults.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }

                } catch (error) {
                    console.error(`ä¸‹è½½ç¬¬ ${i + 1} å¼ å›¾ç‰‡å¤±è´¥:`, error);
                    // ç»§ç»­ä¸‹è½½å…¶ä»–å›¾ç‰‡ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                }
            }

            console.log("æ‰¹é‡ä¸‹è½½å®Œæˆï¼");
        });

        document.getElementById("zipDownloadBtn").addEventListener("click", async () => {
            const matchedResults = bResults.filter(b => b.matched);
            if (matchedResults.length === 0) {
                alert("æ²¡æœ‰å·²åŒ¹é…çš„å›¾ç‰‡å¯ä»¥æ‰“åŒ…ä¸‹è½½ï¼");
                return;
            }

            try {
                console.log(`å¼€å§‹æ‰“åŒ… ${matchedResults.length} å¼ å›¾ç‰‡...`);
                const zip = new JSZip();

                // æ·»åŠ æ–‡ä»¶åˆ° ZIPï¼Œä½¿ç”¨å®‰å…¨çš„æ–‡ä»¶å
                matchedResults.forEach((b, i) => {
                    const fileName = b.downloadName || `matched_${i + 1}.${b.file.name.split('.').pop()}`;
                    // ç¡®ä¿æ–‡ä»¶åå®‰å…¨ï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦
                    const safeFileName = fileName.replace(/[<>:"/\\|?*]/g, '_');
                    zip.file(safeFileName, b.file);
                });

                console.log("æ­£åœ¨ç”Ÿæˆ ZIP æ–‡ä»¶...");
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                });

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blobUrl = URL.createObjectURL(content);
                const a = document.createElement("a");
                a.href = blobUrl;
                a.download = `matched_B_group_${new Date().getTime()}.zip`;
                a.style.display = "none";
                document.body.appendChild(a);
                a.click();

                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                }, 100);

                console.log("ZIP ä¸‹è½½å®Œæˆï¼");

            } catch (error) {
                console.error("ZIP æ‰“åŒ…å¤±è´¥:", error);
                alert("ZIP æ‰“åŒ…å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
            }
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
            aResults = [];
            bResults = [];
            selectedA = null;
            selectedB = null;
            ocrDoneOnce = false;
            document.getElementById("aPreview").innerHTML = "";
            document.getElementById("bPreview").innerHTML = "";
            document.getElementById("log").textContent = "";
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ä¸è®¡æ•°
            const aFilesEl = document.getElementById("aFiles");
            const bFilesEl = document.getElementById("bFiles");
            if (aFilesEl) aFilesEl.value = "";
            if (bFilesEl) bFilesEl.value = "";
            const aCountEl = document.getElementById("aFileCount");
            const bCountEl = document.getElementById("bFileCount");
            if (aCountEl) aCountEl.textContent = "æœªé€‰æ‹©æ–‡ä»¶";
            if (bCountEl) bCountEl.textContent = "æœªé€‰æ‹©æ–‡ä»¶";
            // å…³é—­å¯èƒ½æ‰“å¼€çš„é¢„è§ˆæ¨¡æ€
            const modals = document.querySelectorAll('.image-preview-modal');
            modals.forEach(m => m.parentNode && m.parentNode.removeChild(m));
            // ç¦ç”¨ç¡®è®¤æŒ‰é’®å¹¶è¿˜åŸæ ·å¼
            const confirmBtn = document.getElementById("confirmBtn");
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.style.opacity = "0.5";
            }
            updateStats();
        });

        // ç›¸ä¼¼åº¦é˜ˆå€¼æ§ä»¶è”åŠ¨æ˜¾ç¤º
        (function () {
            const input = document.getElementById("thresholdInput");
            const label = document.getElementById("thresholdValue");
            const sync = () => {
                if (!input || !label) return;
                const v = parseFloat(input.value || "0.5");
                label.textContent = (isNaN(v) ? 0.5 : v).toFixed(2);
            };
            let debounceTimer = null;
            const scheduleRecompute = () => {
                sync();
                if (!ocrDoneOnce) return;
                if (debounceTimer) clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    recomputeAutoMatchingFromThreshold();
                }, 150);
            };
            if (input) {
                input.addEventListener("input", scheduleRecompute);
                input.addEventListener("change", scheduleRecompute);
                sync();
            }
        })();

        // QPS åŠ¨æ€æ˜¾ç¤ºä¸æœåŠ¡å™¨é…ç½®åŒæ­¥
        (async function () {
            const input = document.getElementById("qpsInput");
            const label = document.getElementById("qpsValue");
            const sync = () => {
                if (!input || !label) return;
                const v = parseInt(input.value || "6", 10);
                label.textContent = (isNaN(v) || v < 1 ? 6 : v).toString();
            };

            // ä»æœåŠ¡å™¨è·å–é…ç½®å¹¶æ›´æ–° QPS æ»‘å—
            try {
                const res = await fetch(`${API_BASE_URL}/config`);
                const config = await res.json();
                if (config.maxQPS) {
                    input.max = config.maxQPS;
                    // ä½¿ç”¨æœåŠ¡å™¨é…ç½®çš„ maxQPS ä½œä¸ºé»˜è®¤å€¼ï¼ˆå¦‚æœæœåŠ¡å™¨æ”¯æŒçš„è¯ï¼‰
                    input.value = Math.min(6, config.maxQPS);
                    sync();
                    console.log(`âœ… å·²ä»æœåŠ¡å™¨è·å–é…ç½®: æœ€å¤§QPS=${config.maxQPS} (${config.totalKeys}ä¸ªAPI Key)`);
                }
            } catch (e) {
                console.warn('âš ï¸ æ— æ³•è·å–æœåŠ¡å™¨é…ç½®ï¼Œä½¿ç”¨é»˜è®¤QPSé™åˆ¶=6');
            }

            if (input) {
                input.addEventListener("input", sync);
                input.addEventListener("change", sync);
                sync();
            }
        })();








    </script>
</body>

</html>